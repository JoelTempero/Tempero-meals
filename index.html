<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>J&R Meals</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root{--bg-dark:#0f172a;--bg-card:#1e293b;--bg-input:#334155;--primary:#f97316;--primary-light:#fb923c;--secondary:#2dd4bf;--secondary-light:#5eead4;--accent:#fbbf24;--tomato:#ef4444;--cream:#fef3c7;--text-primary:#f8fafc;--text-secondary:#cbd5e1;--text-muted:#64748b;--rachel:#f472b6;--joel:#60a5fa;--glass:rgba(255,255,255,0.05);--glow:rgba(249,115,22,0.2)}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;min-height:100dvh}
        input,textarea,select{-webkit-user-select:auto;user-select:auto}
        .hidden{display:none!important}
        button{min-height:48px;min-width:48px;touch-action:manipulation;cursor:pointer;border:none;font-family:inherit}
        .pin-screen{position:fixed;inset:0;background:var(--bg-dark);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;padding:2rem}
        .pin-logo{font-size:2.5rem;font-weight:800;margin-bottom:0.5rem;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .pin-subtitle{color:var(--text-muted);margin-bottom:2rem;font-size:0.9rem}
        .pin-dots{display:flex;gap:1rem;margin-bottom:2rem}
        .pin-dot{width:16px;height:16px;border-radius:50%;background:var(--bg-input);border:2px solid var(--text-muted);transition:all 0.2s}
        .pin-dot.filled{background:var(--primary);border-color:var(--primary);box-shadow:0 0 10px var(--glow)}
        .pin-dot.error{background:var(--tomato);border-color:var(--tomato);animation:shake 0.5s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        .pin-key{width:72px;height:72px;border-radius:50%;background:var(--bg-card);color:var(--text-primary);font-size:1.5rem;font-weight:600;touch-action:manipulation;border:1px solid rgba(255,255,255,0.1);transition:all 0.15s}
        .pin-key:active{transform:scale(0.9);background:var(--primary);color:white}
        .pin-key.empty{visibility:hidden}
        .app{display:none;flex-direction:column;min-height:100vh;min-height:100dvh;padding-bottom:100px}
        .app.active{display:flex}
        .header{padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,var(--bg-card) 0%,transparent 100%);position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
        .header-left{display:flex;align-items:center;gap:0.75rem}
        .header-icon{font-size:1.5rem}
        .header-title{font-size:1.25rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .header-date{color:var(--text-muted);font-size:0.8rem}
        .header-btn{background:var(--glass);backdrop-filter:blur(10px);color:var(--text-primary);width:44px;height:44px;border-radius:12px;font-size:1.25rem;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.1)}
        .page{display:none;flex:1;padding:1rem;overflow-y:auto;padding-bottom:20px}
        .page.active{display:block}
        .card{background:var(--bg-card);border-radius:20px;padding:1.25rem;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.05);box-shadow:0 4px 20px rgba(0,0,0,0.2)}
        .card-title{font-size:1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;color:var(--text-secondary)}
        .week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
        .week-nav button{background:var(--glass);backdrop-filter:blur(10px);color:var(--text-primary);width:44px;height:44px;border-radius:12px;font-size:1.25rem;border:1px solid rgba(255,255,255,0.1)}
        .week-nav button:active{background:var(--bg-input)}
        .week-title{font-size:1rem;font-weight:600;text-align:center;color:var(--text-secondary)}
        .day-card{background:var(--bg-card);border-radius:16px;padding:1rem;margin-bottom:0.75rem;border:1px solid rgba(255,255,255,0.05)}
        .day-header{font-weight:700;font-size:0.85rem;color:var(--primary);margin-bottom:0.75rem;display:flex;justify-content:space-between;align-items:center}
        .day-date{color:var(--text-muted);font-weight:400;font-size:0.75rem}
        .meal-slot{background:var(--bg-input);border-radius:12px;padding:0.75rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer;transition:all 0.2s;border:1px solid transparent}
        .meal-slot:active{transform:scale(0.98);border-color:var(--primary)}
        .meal-slot-icon{font-size:1.25rem;width:36px;text-align:center}
        .meal-slot-content{flex:1;min-width:0}
        .meal-slot-type{font-size:0.65rem;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px}
        .meal-slot-name{font-weight:600;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .meal-slot-name.empty{color:var(--text-muted);font-style:italic;font-weight:400}
        .meal-slot-meta{font-size:0.7rem;color:var(--text-muted);margin-top:0.15rem}
        .meal-slot-arrow{color:var(--text-muted);font-size:0.9rem}
        .meals-search{display:flex;gap:0.5rem;margin-bottom:1rem}
        .meals-search input{flex:1;background:var(--bg-input);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.75rem 1rem;color:var(--text-primary);font-size:0.95rem;min-height:48px}
        .meals-search input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--glow)}
        .meals-search input::placeholder{color:var(--text-muted)}
        .tag-filter{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem}
        .tag-btn{padding:0.4rem 0.75rem;border-radius:20px;background:var(--glass);backdrop-filter:blur(10px);color:var(--text-muted);font-size:0.75rem;font-weight:600;min-height:32px;min-width:auto;border:1px solid rgba(255,255,255,0.1);transition:all 0.2s}
        .tag-btn.active{background:var(--primary);color:var(--bg-dark);border-color:var(--primary)}
        .meal-item{background:var(--bg-card);border-radius:16px;padding:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer;transition:all 0.2s;border:1px solid rgba(255,255,255,0.05)}
        .meal-item:active{transform:scale(0.98);border-color:var(--primary)}
        .meal-item-icon{font-size:1.5rem;width:44px;text-align:center}
        .meal-item-content{flex:1;min-width:0}
        .meal-item-name{font-weight:600;font-size:0.95rem}
        .meal-item-tags{display:flex;gap:0.35rem;flex-wrap:wrap;margin-top:0.35rem}
        .meal-tag{font-size:0.6rem;padding:0.2rem 0.5rem;border-radius:10px;background:var(--bg-input);color:var(--text-muted)}
        .meal-tag.fresh{background:rgba(45,212,191,0.15);color:var(--secondary)}
        .meal-tag.frozen{background:rgba(96,165,250,0.15);color:var(--joel)}
        .meal-tag.fast,.meal-tag.quick{background:rgba(249,115,22,0.15);color:var(--primary)}
        .meal-tag.bulk,.meal-tag.bulkprep{background:rgba(251,191,36,0.15);color:var(--accent)}
        .meal-tag.comfort{background:rgba(168,85,247,0.15);color:#a855f7}
        .meal-tag.healthy{background:rgba(34,197,94,0.15);color:#22c55e}
        .meal-tag.vegetarian{background:rgba(34,197,94,0.15);color:#22c55e}
        .slot-container{display:flex;flex-direction:column;align-items:center;padding:1.5rem 1rem}
        .slot-window{position:relative;width:100%;max-width:320px;height:280px;background:var(--bg-card);border-radius:24px;overflow:hidden;margin-bottom:1.5rem;border:2px solid rgba(255,255,255,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.1)}
        .slot-highlight{position:absolute;top:50%;left:0;right:0;height:70px;transform:translateY(-50%);background:linear-gradient(90deg,transparent,var(--glow),transparent);border-top:1px solid var(--primary);border-bottom:1px solid var(--primary);z-index:10;pointer-events:none}
        .slot-reel{position:absolute;top:0;left:0;right:0;transition:transform 0.1s linear}
        .slot-item{height:70px;display:flex;align-items:center;justify-content:center;gap:0.75rem;padding:0 1rem}
        .slot-item-icon{font-size:2rem;flex-shrink:0}
        .slot-item-name{font-size:1.1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .spin-btn{background:linear-gradient(135deg,var(--primary),#ea580c);color:white;padding:1rem 3rem;border-radius:16px;font-size:1.1rem;font-weight:700;box-shadow:0 4px 20px var(--glow);border:none}
        .spin-btn:active{transform:scale(0.95)}
        .spin-btn:disabled{opacity:0.5;transform:none}
        .spin-result{text-align:center;margin-top:1.5rem;padding:1.5rem;background:var(--bg-card);border-radius:20px;display:none;width:100%;max-width:320px;border:1px solid rgba(255,255,255,0.1)}
        .spin-result.show{display:block;animation:resultPop 0.3s ease}
        @keyframes resultPop{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
        .confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;overflow:hidden}
        .confetti{position:absolute;width:10px;height:10px;opacity:0;animation:confetti-fall 3s ease-out forwards}
        @keyframes confetti-fall{0%{transform:translateY(-100px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
        .spin-result-title{font-size:0.85rem;color:var(--text-muted);margin-bottom:0.5rem}
        .spin-result-meal{font-size:1.3rem;font-weight:700;margin-bottom:1rem}
        .spin-result-actions{display:flex;gap:0.75rem;justify-content:center}
        .spin-result-actions button{padding:0.75rem 1.25rem;border-radius:12px;font-weight:600;font-size:0.85rem}
        .btn-make{background:var(--primary);color:white}
        .btn-calendar{background:var(--secondary);color:var(--bg-dark)}
        .cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .cart-count{font-size:0.8rem;color:var(--text-muted)}
        .clear-cart-btn{background:var(--tomato);color:white;padding:0.5rem 1rem;border-radius:10px;font-size:0.75rem;font-weight:600;min-height:36px}
        .cart-add-section{margin-bottom:1rem}
        .cart-add-btns{display:flex;gap:0.5rem;margin-top:0.5rem}
        .cart-add-btn{flex:1;background:var(--glass);backdrop-filter:blur(10px);color:var(--text-secondary);padding:0.6rem;border-radius:10px;font-size:0.8rem;font-weight:600;border:1px solid rgba(255,255,255,0.1)}
        .cart-add-btn:active{background:var(--bg-input)}
        .cart-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-card);border-radius:12px;margin-bottom:0.5rem;border:1px solid rgba(255,255,255,0.05)}
        .cart-item.checked{opacity:0.5}
        .cart-item.checked .cart-item-name{text-decoration:line-through}
        .cart-checkbox{width:24px;height:24px;border-radius:8px;border:2px solid var(--text-muted);background:transparent;display:flex;align-items:center;justify-content:center;font-size:0.85rem;min-height:24px;min-width:24px;transition:all 0.2s}
        .cart-checkbox.checked{background:var(--secondary);border-color:var(--secondary);color:var(--bg-dark)}
        .cart-item-content{flex:1}
        .cart-item-name{font-weight:600;font-size:0.9rem}
        .cart-item-amount{font-size:0.7rem;color:var(--text-muted)}
        .cart-item-source{font-size:0.6rem;color:var(--text-muted);font-style:italic}
        .cart-item-delete{color:var(--tomato);font-size:1rem;background:transparent;min-height:32px;min-width:32px}
        .awards-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem}
        .award-item{text-align:center;padding:0.75rem 0.25rem;background:var(--bg-card);border-radius:16px;cursor:pointer;position:relative;border:1px solid rgba(255,255,255,0.05);transition:all 0.2s}
        .award-item:active{transform:scale(0.95)}
        .award-item.locked{opacity:0.35}
        .award-item.earned{border-color:var(--primary);box-shadow:0 0 20px var(--glow)}
        .award-icon{font-size:1.75rem;margin-bottom:0.25rem}
        .award-name{font-size:0.55rem;color:var(--text-muted);line-height:1.2}
        .award-badges{display:flex;justify-content:center;gap:0.25rem;margin-top:0.25rem}
        .award-badge{width:18px;height:18px;border-radius:50%;font-size:0.5rem;font-weight:700;display:flex;align-items:center;justify-content:center}
        .award-badge.rachel{background:var(--rachel);color:white}
        .award-badge.joel{background:var(--joel);color:white}
        .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(30,41,59,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);display:flex;padding:0.5rem 0.5rem max(0.5rem,env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,0.1);z-index:100}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:0.25rem;padding:0.5rem;border-radius:12px;background:transparent;color:var(--text-muted);font-size:0.6rem;font-weight:600;transition:all 0.2s}
        .nav-item.active{color:var(--primary)}
        .nav-item .icon{font-size:1.25rem;margin-bottom:0.1rem}
        .nav-item .icon{font-size:1.5rem}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:flex-end;z-index:200}
        .modal-overlay.active{display:flex}
        .modal-content{background:var(--bg-card);width:100%;border-radius:24px 24px 0 0;padding:1.5rem;padding-bottom:max(1.5rem,env(safe-area-inset-bottom));max-height:85vh;overflow-y:auto;border:1px solid rgba(255,255,255,0.1);border-bottom:none}
        .slot-tag-filter{display:flex;gap:0.5rem;flex-wrap:wrap;margin:0.5rem 0}
        .slot-tag-filter .tag-btn{padding:0.25rem 0.5rem;font-size:0.7rem;min-height:28px}
        .meal-picker-list{max-height:200px;overflow-y:auto;border-radius:12px;background:var(--bg-input);margin-top:0.5rem}
        .meal-picker-item{padding:0.75rem 1rem;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:background 0.2s}
        .meal-picker-item:last-child{border-bottom:none}
        .meal-picker-item:hover,.meal-picker-item:active{background:rgba(255,255,255,0.05)}
        .meal-picker-item.selected{background:var(--glow);border-left:3px solid var(--primary)}
        .meal-picker-item-name{font-weight:600;font-size:0.9rem}
        .meal-picker-item-tags{font-size:0.7rem;color:var(--text-muted);margin-top:0.15rem}
        .meal-picker-section{font-size:0.7rem;font-weight:600;color:var(--text-muted);padding:0.5rem 1rem;background:var(--bg-dark);text-transform:uppercase;letter-spacing:0.5px}
        .modal-title{font-size:1.25rem;font-weight:700;text-align:center;margin-bottom:1.5rem}
        .modal-close{width:100%;padding:1rem;margin-top:0.5rem;background:transparent;border:2px solid var(--text-muted);border-radius:12px;color:var(--text-secondary);font-size:1rem}
        .full-modal{position:fixed;inset:0;background:var(--bg-dark);display:none;flex-direction:column;z-index:300;overflow-y:auto}
        .full-modal.active{display:flex}
        .full-modal-header{padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem;background:var(--bg-card);position:sticky;top:0;z-index:10}
        .full-modal-back{width:44px;height:44px;border-radius:50%;background:var(--bg-input);color:var(--text-primary);font-size:1.25rem;display:flex;align-items:center;justify-content:center}
        .full-modal-title{font-size:1.25rem;font-weight:700;flex:1}
        .full-modal-content{flex:1;padding:1rem;padding-bottom:100px}
        .form-group{margin-bottom:1rem}
        .form-label{font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem;display:block}
        .form-input{width:100%;background:var(--bg-input);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.875rem 1rem;color:var(--text-primary);font-size:0.95rem;min-height:50px;transition:all 0.2s}
        .form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--glow)}
        .form-input:focus{outline:none;border-color:var(--primary)}
        .form-textarea{min-height:100px;resize:vertical;font-family:inherit}
        .ingredient-row{display:flex;gap:0.5rem;align-items:center;margin-bottom:0.5rem}
        .ingredient-row input{flex:1}
        .ingredient-row .amount{width:80px}
        .ingredient-row .delete-btn{background:var(--tomato);color:white;width:36px;height:36px;border-radius:8px;font-size:1rem;min-height:36px;min-width:36px}
        .add-row-btn{width:100%;padding:0.75rem;border:2px dashed var(--text-muted);border-radius:12px;background:transparent;color:var(--text-muted);font-size:0.9rem;margin-top:0.5rem}
        .step-item{display:flex;gap:0.75rem;margin-bottom:0.75rem}
        .step-num{width:28px;height:28px;border-radius:50%;background:var(--primary);color:var(--bg-dark);font-size:0.8rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .step-content{flex:1}
        .step-content textarea{width:100%;background:var(--bg-input);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:0.5rem;color:var(--text-primary);font-size:0.9rem;min-height:60px;resize:vertical}
        .step-delete{background:var(--tomato);color:white;width:28px;height:28px;border-radius:6px;font-size:0.8rem;min-height:28px;min-width:28px;flex-shrink:0}
        .tags-input{padding:0.75rem;background:var(--bg-input);border-radius:12px}
        .selected-tags{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.5rem;min-height:28px}
        .available-tags{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.5rem;padding-bottom:0.5rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        .available-tag-btn{padding:0.25rem 0.6rem;background:var(--bg-card);color:var(--text-muted);border-radius:15px;font-size:0.75rem;font-weight:500;min-height:28px}
        .available-tag-btn:hover,.available-tag-btn:active{background:var(--primary);color:var(--bg-dark)}
        .new-tag-row{display:flex;gap:0.5rem}
        .new-tag-row input{flex:1;background:transparent;border:none;color:var(--text-primary);font-size:0.9rem;padding:0.25rem}
        .new-tag-row input:focus{outline:none}
        .add-tag-btn{width:32px;height:32px;background:var(--primary);color:var(--bg-dark);border-radius:8px;font-size:1.2rem;font-weight:700;min-height:32px;min-width:32px}
        .tag-chip{display:flex;align-items:center;gap:0.25rem;padding:0.25rem 0.5rem;background:var(--primary);color:var(--bg-dark);border-radius:15px;font-size:0.75rem;font-weight:600}
        .tag-chip button{background:transparent;color:var(--bg-dark);font-size:0.9rem;min-height:auto;min-width:auto;padding:0;margin-left:0.25rem}
        .submit-btn{position:fixed;bottom:0;left:0;right:0;padding:1rem;padding-bottom:max(1rem,env(safe-area-inset-bottom));background:var(--bg-card)}
        .submit-btn button{width:100%;padding:1rem;border-radius:12px;font-size:1.1rem;font-weight:600;min-height:56px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:var(--bg-dark)}
        .submit-btn button:active{transform:scale(0.98)}
        .recipe-view{padding:1rem}
        .recipe-header{text-align:center;margin-bottom:1.5rem}
        .recipe-icon{font-size:3rem;margin-bottom:0.5rem}
        .recipe-name{font-size:1.5rem;font-weight:700}
        .recipe-tags{display:flex;justify-content:center;gap:0.5rem;margin-top:0.5rem}
        .recipe-section{margin-bottom:1.5rem}
        .recipe-section-title{font-size:1rem;font-weight:700;color:var(--primary);margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
        .recipe-ingredient{padding:0.5rem 0;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between}
        .recipe-ingredient:last-child{border-bottom:none}
        .recipe-step{display:flex;gap:1rem;margin-bottom:1rem}
        .recipe-step-num{width:32px;height:32px;border-radius:50%;background:var(--primary);color:var(--bg-dark);font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .recipe-step-text{flex:1;line-height:1.5}
        .recipe-nav{display:flex;gap:1rem;justify-content:center;margin-top:1rem}
        .recipe-nav button{padding:0.75rem 1.5rem;border-radius:10px;font-weight:600}
        .recipe-nav .prev{background:var(--bg-input);color:var(--text-primary)}
        .recipe-nav .next{background:var(--primary);color:var(--bg-dark)}
        .step-single{text-align:center;padding:2rem 1rem}
        .step-single-num{font-size:1rem;color:var(--text-muted);margin-bottom:0.5rem}
        .step-single-text{font-size:1.25rem;line-height:1.6}
        .view-toggle{display:flex;gap:0.5rem;justify-content:center;margin-bottom:1rem}
        .view-toggle button{padding:0.5rem 1rem;border-radius:8px;background:var(--bg-input);color:var(--text-secondary);font-size:0.8rem;font-weight:600;min-height:36px}
        .view-toggle button.active{background:var(--primary);color:var(--bg-dark)}
        .recipe-actions{display:flex;gap:0.75rem;justify-content:center;margin-top:1.5rem}
        .recipe-actions button{padding:0.75rem 1.25rem;border-radius:10px;font-weight:600;font-size:0.9rem}
        .person-select{display:flex;gap:0.5rem;flex-wrap:wrap}
        .person-btn{padding:0.5rem 1rem;border-radius:12px;background:var(--bg-input);color:var(--text-secondary);font-size:0.85rem;font-weight:600;min-height:36px;position:relative;display:inline-flex;align-items:center;gap:0.25rem;border:1px solid transparent;transition:all 0.2s}
        .person-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
        .person-btn.rachel.active{background:var(--rachel);border-color:var(--rachel)}
        .person-btn.joel.active{background:var(--joel);border-color:var(--joel)}
        .person-btn.add-custom-btn{border:1px dashed var(--text-muted);background:transparent;min-width:36px;padding:0.5rem}
        .delete-custom{font-size:0.75rem;color:var(--tomato);margin-left:0.25rem;font-weight:700}
        .meal-option-btn{display:flex;align-items:center;gap:1rem;width:100%;padding:1rem;background:var(--bg-input);border-radius:12px;color:var(--text-primary);font-size:1rem;font-weight:600;margin-bottom:0.75rem}
        .meal-option-btn:active{background:var(--bg-dark)}
        .meal-option-btn .icon{font-size:1.5rem;width:44px;text-align:center}
        .toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--primary);color:var(--bg-dark);padding:1rem 1.5rem;border-radius:12px;font-weight:600;opacity:0;transition:all 0.3s;z-index:400}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.error{background:var(--tomato);color:white}
        .sync-status{position:fixed;top:0;left:0;right:0;height:3px;z-index:500}
        .sync-status.syncing{background:linear-gradient(90deg,transparent,var(--primary),transparent);animation:syncPulse 1.5s infinite}
        @keyframes syncPulse{0%,100%{opacity:0.3}50%{opacity:1}}
        .settings-section{margin-bottom:1.5rem}
        .settings-section-title{font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.75rem}
        .settings-row{display:flex;align-items:center;justify-content:space-between;padding:0.75rem;background:var(--bg-input);border-radius:10px;margin-bottom:0.5rem}
        .settings-row label{font-weight:600}
        .settings-row input{width:60%;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:0.5rem;color:var(--text-primary);text-align:right}
        .people-list,.tags-list{margin-top:0.5rem}
        .people-item,.tags-item{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem}
        .people-item input,.tags-item input{flex:1;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:0.5rem;color:var(--text-primary)}
        .people-item button,.tags-item button{background:var(--tomato);color:white;width:32px;height:32px;border-radius:6px;font-size:0.9rem;min-height:32px;min-width:32px}
        .tag-count{font-size:0.7rem;color:var(--text-muted);background:var(--bg-input);padding:0.2rem 0.5rem;border-radius:10px;min-width:20px;text-align:center}
        .add-person-btn{width:100%;padding:0.5rem;border:2px dashed var(--text-muted);border-radius:8px;background:transparent;color:var(--text-muted);font-size:0.85rem;margin-top:0.5rem}
        .empty-state{text-align:center;padding:3rem 1rem;color:var(--text-muted)}
        .empty-state-icon{font-size:3rem;margin-bottom:1rem}
        .confirm-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:400;padding:1rem}
        .confirm-modal.active{display:flex}
        .confirm-box{background:var(--bg-card);border-radius:20px;padding:1.5rem;width:100%;max-width:340px;text-align:center}
        .confirm-text{margin-bottom:1.5rem;color:var(--text-secondary)}
        .confirm-btns{display:flex;gap:0.75rem}
        .confirm-btns button{flex:1;padding:0.875rem;border-radius:12px;font-weight:600}
        .confirm-cancel{background:var(--bg-input);color:var(--text-secondary)}
        .confirm-ok{background:var(--tomato);color:white}
        .award-modal-content{text-align:center;padding:1rem}
        .award-modal-icon{font-size:4rem;margin-bottom:1rem}
        .award-modal-name{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem}
        .award-modal-desc{color:var(--text-secondary);margin-bottom:1rem}
        .award-modal-earned{display:flex;justify-content:center;gap:1rem}
        .award-earned-person{padding:0.5rem 1rem;border-radius:20px;font-weight:600;font-size:0.9rem}
        .award-earned-person.rachel{background:rgba(244,114,182,0.2);color:var(--rachel)}
        .award-earned-person.joel{background:rgba(96,165,250,0.2);color:var(--joel)}
        .award-earned-person.locked{background:var(--bg-input);color:var(--text-muted)}
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus"></div>
    <div class="pin-screen" id="pinScreen">
        <div class="pin-logo">J&R Meals</div>
        <div class="pin-subtitle">Enter PIN to continue</div>
        <div class="pin-dots" id="pinDots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
        <div class="pin-keypad">
            <button class="pin-key" data-num="1">1</button><button class="pin-key" data-num="2">2</button><button class="pin-key" data-num="3">3</button>
            <button class="pin-key" data-num="4">4</button><button class="pin-key" data-num="5">5</button><button class="pin-key" data-num="6">6</button>
            <button class="pin-key" data-num="7">7</button><button class="pin-key" data-num="8">8</button><button class="pin-key" data-num="9">9</button>
            <button class="pin-key empty"></button><button class="pin-key" data-num="0">0</button><button class="pin-key" data-action="back">‚å´</button>
        </div>
    </div>
    <div class="app" id="app">
        <header class="header">
            <div class="header-left"><img src="icon-192.png" alt="J&R" style="width:2.25rem;height:2.25rem;border-radius:10px"><div><div class="header-title">J&R Meals</div><div class="header-date" id="headerDate"></div></div></div>
            <button class="header-btn" id="settingsBtn">‚öôÔ∏è</button>
        </header>
        <div class="page active" id="pageCalendar">
            <div class="card">
                <div class="week-nav"><button id="prevWeek">‚Äπ</button><div class="week-title" id="weekTitle"></div><button id="nextWeek">‚Ä∫</button></div>
                <div id="weekDays"></div>
            </div>
        </div>
        <div class="page" id="pageMeals">
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
                <div class="meals-search" style="flex:1;margin:0"><input type="text" id="mealsSearchInput" placeholder="Search meals..."></div>
                <button style="background:var(--primary);color:var(--bg-dark);padding:0 1.25rem;border-radius:12px;font-weight:700;font-size:1.5rem;min-width:50px" onclick="openMealForm()">+</button>
            </div>
            <div class="tag-filter" id="tagFilter"></div>
            <div id="mealsList"></div>
        </div>
        <div class="page" id="pagePicker">
            <div class="card">
                <div class="card-title">üé∞ Meal Picker</div>
                <div class="tag-filter" id="pickerTagFilter"></div>
                <div class="meals-search"><input type="text" id="pickerIngredientInput" placeholder="Filter by ingredient..."></div>
            </div>
            <div class="slot-container">
                <div class="slot-window">
                    <div class="slot-highlight"></div>
                    <div class="slot-reel" id="slotReel"></div>
                </div>
                <button class="spin-btn" id="spinBtn">üé≤ SPIN!</button>
                <div class="spin-result" id="spinResult">
                    <div class="spin-result-title">Tonight's meal is...</div>
                    <div class="spin-result-meal" id="spinResultMeal"></div>
                    <div class="spin-result-actions">
                        <button class="btn-make" id="spinMakeBtn">üë®‚Äçüç≥ Make It</button>
                        <button class="btn-calendar" id="spinCalendarBtn">üìÖ Add to Calendar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="page" id="pageCart">
            <div class="card">
                <div class="cart-header"><div class="card-title">üõí Shopping Cart</div><button class="clear-cart-btn" id="clearCartBtn">Clear All</button></div>
                <div class="cart-count" id="cartCount">0 items</div>
            </div>
            <div class="card cart-add-section">
                <div class="form-label">Add items from:</div>
                <div class="cart-add-btns">
                    <button class="cart-add-btn" id="addFromMealBtn">From Meal</button>
                    <button class="cart-add-btn" id="addCustomItemBtn">‚úèÔ∏è Custom Item</button>
                </div>
            </div>
            <div id="cartItems"></div>
        </div>
        <div class="page" id="pageAwards">
            <div class="card">
                <div class="card-title">üèÜ Achievements</div>
                <div class="awards-grid" id="awardsGrid"></div>
            </div>
        </div>
        <nav class="nav">
            <button class="nav-item active" data-page="pageCalendar"><span class="icon">üìÖ</span>Calendar</button>
            <button class="nav-item" data-page="pageMeals"><span class="icon">üçΩÔ∏è</span>Meals</button>
            <button class="nav-item" data-page="pagePicker"><span class="icon">üé∞</span>Picker</button>
            <button class="nav-item" data-page="pageCart"><span class="icon">üõí</span>Cart</button>
            <button class="nav-item" data-page="pageAwards"><span class="icon">üèÜ</span>Awards</button>
        </nav>
    </div>
    <div class="modal-overlay" id="mealOptionsModal">
        <div class="modal-content">
            <div class="modal-title" id="mealOptionsTitle">Meal Options</div>
            <button class="meal-option-btn" id="optionMake"><span class="icon">üë®‚Äçüç≥</span>Make This Meal</button>
            <button class="meal-option-btn" id="optionCalendar"><span class="icon">üìÖ</span>Add to Calendar</button>
            <button class="meal-option-btn" id="optionEdit"><span class="icon">‚úèÔ∏è</span>Edit Meal</button>
            <button class="meal-option-btn" id="optionDelete" style="color:var(--tomato)"><span class="icon">üóëÔ∏è</span>Delete Meal</button>
            <button class="modal-close" id="closeMealOptions">Cancel</button>
        </div>
    </div>
    <div class="modal-overlay" id="slotModal">
        <div class="modal-content">
            <div class="modal-title">Assign Meal</div>
            <div class="form-group">
                <label class="form-label">Select Meal</label>
                <input type="text" class="form-input" id="slotMealSearch" placeholder="Search meals...">
                <div class="slot-tag-filter" id="slotTagFilter"></div>
                <div class="meal-picker-list" id="slotMealList"></div>
                <input type="hidden" id="slotMealSelect">
            </div>
            <div class="form-group">
                <label class="form-label">Who's Eating?</label>
                <div class="person-select" id="slotEatingSelect"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Who's Cooking?</label>
                <div class="person-select" id="slotCookingSelect"></div>
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1rem">
                <button class="modal-close" id="closeSlotModal" style="flex:1;margin:0">Cancel</button>
                <button style="flex:1;background:var(--primary);color:white;border-radius:12px;font-weight:600" id="saveSlotBtn">Save</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="addToCalendarModal">
        <div class="modal-content">
            <div class="modal-title">Add to Calendar</div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="calendarDateInput">
            </div>
            <div class="form-group">
                <label class="form-label">Meal Type</label>
                <div class="person-select">
                    <button class="person-btn active" data-type="lunch" id="calTypeLunch">üåû Lunch</button>
                    <button class="person-btn" data-type="dinner" id="calTypeDinner">üåô Dinner</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Who's Eating?</label>
                <div class="person-select" id="calEatingSelect"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Who's Cooking?</label>
                <div class="person-select" id="calCookingSelect"></div>
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1rem">
                <button class="modal-close" id="closeCalendarModal" style="flex:1;margin:0">Cancel</button>
                <button style="flex:1;background:var(--primary);color:var(--bg-dark);border-radius:12px;font-weight:600" id="saveCalendarBtn">Add</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="addFromMealModal">
        <div class="modal-content">
            <div class="modal-title">Add Ingredients from Meal</div>
            <div class="form-group">
                <select class="form-input" id="cartMealSelect"></select>
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1rem">
                <button class="modal-close" id="closeAddFromMealModal" style="flex:1;margin:0">Cancel</button>
                <button style="flex:1;background:var(--primary);color:var(--bg-dark);border-radius:12px;font-weight:600" id="addMealToCartBtn">Add All Ingredients</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="addCustomItemModal">
        <div class="modal-content">
            <div class="modal-title">Add Custom Item</div>
            <div class="form-group">
                <label class="form-label">Item Name</label>
                <input type="text" class="form-input" id="customItemName" placeholder="e.g., Milk">
            </div>
            <div class="form-group">
                <label class="form-label">Amount (optional)</label>
                <input type="text" class="form-input" id="customItemAmount" placeholder="e.g., 2 liters">
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1rem">
                <button class="modal-close" id="closeCustomItemModal" style="flex:1;margin:0">Cancel</button>
                <button style="flex:1;background:var(--primary);color:var(--bg-dark);border-radius:12px;font-weight:600" id="addCustomItemToCartBtn">Add</button>
            </div>
        </div>
    </div>
    <div class="full-modal" id="mealFormModal">
        <div class="full-modal-header">
            <button class="full-modal-back" id="closeMealForm">‚Üê</button>
            <div class="full-modal-title" id="mealFormTitle">New Meal</div>
            <button style="background:var(--tomato);color:white;padding:0.5rem 1rem;border-radius:8px;font-size:0.8rem;font-weight:600;min-height:36px;display:none" id="deleteMealBtn">Delete</button>
        </div>
        <div class="full-modal-content">
            <div class="form-group">
                <label class="form-label">Meal Name</label>
                <input type="text" class="form-input" id="mealNameInput" placeholder="e.g., Spaghetti Bolognese">
            </div>
            <div class="form-group">
                <label class="form-label">Tags</label>
                <div class="tags-input" id="tagsInput">
                    <input type="text" id="tagInputField" placeholder="Add tag...">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Ingredients</label>
                <div id="ingredientsList"></div>
                <button class="add-row-btn" id="addIngredientBtn">+ Add Ingredient</button>
            </div>
            <div class="form-group">
                <label class="form-label">Recipe Steps</label>
                <div id="stepsList"></div>
                <button class="add-row-btn" id="addStepBtn">+ Add Step</button>
            </div>
        </div>
        <div class="submit-btn"><button id="saveMealBtn">Save Meal</button></div>
    </div>
    <div class="full-modal" id="recipeModal">
        <div class="full-modal-header">
            <button class="full-modal-back" id="closeRecipe">‚Üê</button>
            <div class="full-modal-title">Recipe</div>
        </div>
        <div class="recipe-view" id="recipeView"></div>
    </div>
    <div class="full-modal" id="settingsModal">
        <div class="full-modal-header">
            <button class="full-modal-back" id="closeSettings">‚Üê</button>
            <div class="full-modal-title">Settings</div>
        </div>
        <div class="full-modal-content">
            <div class="settings-section">
                <div class="settings-section-title">GitHub Sync</div>
                <div class="form-group">
                    <label class="form-label">Personal Access Token</label>
                    <input type="password" class="form-input" id="patInput" placeholder="github_pat_...">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">People</div>
                <div class="people-list" id="peopleList"></div>
                <button class="add-person-btn" id="addPersonBtn">+ Add Person</button>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">üè∑Ô∏è Tags</div>
                <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.5rem">Edit or delete tags. Changes apply to all meals.</p>
                <div class="tags-list" id="tagsList"></div>
                <button class="add-person-btn" id="addTagBtn">+ Add Tag</button>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Data</div>
                <button style="width:100%;padding:0.75rem;background:var(--tomato);color:white;border-radius:8px;font-weight:600;font-size:0.9rem" id="resetDataBtn">Reset All Data</button>
                <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;text-align:center">This will clear all meals, calendar entries, and badges</p>
            </div>
            <div style="margin-top:2rem">
                <button style="width:100%;padding:1rem;background:var(--primary);color:var(--bg-dark);border-radius:12px;font-weight:600;font-size:1rem" id="saveSettingsBtn">Save Settings</button>
            </div>
        </div>
    </div>
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-box">
            <div class="confirm-text" id="confirmText">Are you sure?</div>
            <div class="confirm-btns">
                <button class="confirm-cancel" id="confirmCancel">Cancel</button>
                <button class="confirm-ok" id="confirmOk">Delete</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="awardModal">
        <div class="modal-content">
            <div class="award-modal-content">
                <div class="award-modal-icon" id="awardModalIcon"></div>
                <div class="award-modal-name" id="awardModalName"></div>
                <div class="award-modal-desc" id="awardModalDesc"></div>
                <div class="award-modal-earned" id="awardModalEarned"></div>
            </div>
            <button class="modal-close" id="closeAwardModal">Close</button>
        </div>
    </div>
    <div class="toast" id="toast"></div>
<script>
const CONFIG={PIN:'3489',REPO_NAME:'Tempero-Meals',REPO_OWNER:'',DATA_FILE:'data/meals.json'};
const DEFAULT_PEOPLE=['Rachel','Joel'];
const DEFAULT_TAGS=['Fresh','Frozen','Fast Food','Bulk Prep','Vegetarian','Quick','Comfort','Healthy'];
const STARTER_MEALS=[
{id:'m1',name:'Spaghetti Bolognese',icon:'pasta',tags:['Comfort','Fresh'],ingredients:[{name:'Spaghetti',amount:'400g'},{name:'Ground Beef',amount:'500g'},{name:'Onion',amount:'1 large'},{name:'Garlic',amount:'3 cloves'},{name:'Canned Tomatoes',amount:'400g'},{name:'Tomato Paste',amount:'2 tbsp'},{name:'Olive Oil',amount:'2 tbsp'},{name:'Salt',amount:'to taste'},{name:'Pepper',amount:'to taste'},{name:'Parmesan',amount:'for serving'}],steps:['Dice onion and mince garlic','Brown beef in olive oil, breaking up chunks','Add onion and garlic, cook until soft','Add tomatoes and tomato paste, simmer 20 mins','Season with salt and pepper','Cook spaghetti according to package','Serve sauce over pasta with parmesan']},
{id:'m2',name:'Chicken Stir Fry',icon:'chicken',tags:['Quick','Healthy','Fresh'],ingredients:[{name:'Chicken Breast',amount:'500g'},{name:'Broccoli',amount:'2 cups'},{name:'Bell Pepper',amount:'2'},{name:'Soy Sauce',amount:'3 tbsp'},{name:'Garlic',amount:'2 cloves'},{name:'Ginger',amount:'1 tbsp'},{name:'Sesame Oil',amount:'1 tbsp'},{name:'Rice',amount:'2 cups'}],steps:['Slice chicken into strips','Chop vegetables','Cook rice according to package','Heat oil in wok over high heat','Stir fry chicken until cooked, set aside','Stir fry vegetables 3-4 mins','Return chicken, add sauce ingredients','Serve over rice']},
{id:'m3',name:'Beef Tacos',icon:'taco',tags:['Quick','Fresh'],ingredients:[{name:'Ground Beef',amount:'500g'},{name:'Taco Shells',amount:'12'},{name:'Lettuce',amount:'1 head'},{name:'Tomato',amount:'2'},{name:'Cheese',amount:'1 cup'},{name:'Sour Cream',amount:'1/2 cup'},{name:'Taco Seasoning',amount:'1 packet'}],steps:['Brown beef and drain fat','Add taco seasoning with water per packet','Simmer until thickened','Shred lettuce and dice tomatoes','Warm taco shells','Assemble tacos with toppings']},
{id:'m4',name:'Vegetable Curry',icon:'curry',tags:['Vegetarian','Healthy','Comfort'],ingredients:[{name:'Chickpeas',amount:'400g can'},{name:'Coconut Milk',amount:'400ml'},{name:'Curry Paste',amount:'3 tbsp'},{name:'Onion',amount:'1'},{name:'Potatoes',amount:'2'},{name:'Spinach',amount:'2 cups'},{name:'Rice',amount:'2 cups'}],steps:['Dice onion and potatoes','Saute onion until soft','Add curry paste and cook 1 min','Add potatoes and coconut milk','Simmer 15 mins until potatoes tender','Add chickpeas and spinach','Cook until spinach wilted','Serve over rice']},
{id:'m5',name:'Grilled Salmon',icon:'fish',tags:['Healthy','Fresh','Quick'],ingredients:[{name:'Salmon Fillets',amount:'4'},{name:'Lemon',amount:'2'},{name:'Olive Oil',amount:'2 tbsp'},{name:'Garlic',amount:'2 cloves'},{name:'Dill',amount:'2 tbsp'},{name:'Asparagus',amount:'1 bunch'}],steps:['Preheat grill to medium-high','Season salmon with oil, garlic, dill','Grill salmon 4-5 mins per side','Grill asparagus alongside','Squeeze lemon over salmon','Serve with asparagus']},
{id:'m6',name:'Margherita Pizza',icon:'pizza',tags:['Comfort','Fresh'],ingredients:[{name:'Pizza Dough',amount:'1 ball'},{name:'Tomato Sauce',amount:'1/2 cup'},{name:'Mozzarella',amount:'200g'},{name:'Fresh Basil',amount:'handful'},{name:'Olive Oil',amount:'drizzle'}],steps:['Preheat oven to 250C','Roll out dough on floured surface','Spread sauce leaving border','Add torn mozzarella pieces','Bake 10-12 mins until golden','Top with fresh basil and oil']},
{id:'m7',name:'Caesar Salad',icon:'salad',tags:['Healthy','Quick','Fresh'],ingredients:[{name:'Romaine Lettuce',amount:'2 heads'},{name:'Croutons',amount:'1 cup'},{name:'Parmesan',amount:'1/2 cup'},{name:'Caesar Dressing',amount:'1/2 cup'},{name:'Chicken Breast',amount:'2 (optional)'}],steps:['Chop romaine lettuce','Grill chicken if using, slice','Toss lettuce with dressing','Add croutons and parmesan','Top with chicken slices']},
{id:'m8',name:'Fried Rice',icon:'rice',tags:['Quick','Comfort'],ingredients:[{name:'Cooked Rice',amount:'4 cups'},{name:'Eggs',amount:'3'},{name:'Frozen Peas',amount:'1 cup'},{name:'Carrots',amount:'2'},{name:'Soy Sauce',amount:'3 tbsp'},{name:'Sesame Oil',amount:'1 tbsp'},{name:'Green Onions',amount:'4'}],steps:['Use day-old cold rice','Dice carrots small','Scramble eggs, set aside','Stir fry carrots and peas','Add rice and soy sauce','Mix in eggs','Garnish with green onions']},
{id:'m9',name:'Beef Burgers',icon:'burger',tags:['Comfort','Quick'],ingredients:[{name:'Ground Beef',amount:'500g'},{name:'Burger Buns',amount:'4'},{name:'Cheese',amount:'4 slices'},{name:'Lettuce',amount:'4 leaves'},{name:'Tomato',amount:'1'},{name:'Onion',amount:'1'},{name:'Pickles',amount:'8'},{name:'Ketchup',amount:'to taste'}],steps:['Mix beef with salt and pepper','Form into 4 patties','Grill 4-5 mins per side','Add cheese in last minute','Toast buns','Assemble with toppings']},
{id:'m10',name:'Chicken Soup',icon:'soup',tags:['Comfort','Healthy'],ingredients:[{name:'Chicken',amount:'1 whole'},{name:'Carrots',amount:'3'},{name:'Celery',amount:'3 stalks'},{name:'Onion',amount:'1'},{name:'Egg Noodles',amount:'200g'},{name:'Chicken Stock',amount:'8 cups'},{name:'Thyme',amount:'2 sprigs'}],steps:['Simmer chicken in stock 1 hour','Remove chicken, shred meat','Dice vegetables','Add vegetables to broth','Simmer until tender','Add noodles and chicken','Cook until noodles done']},
{id:'m11',name:'Fish and Chips',icon:'seafood',tags:['Comfort','Frozen'],ingredients:[{name:'White Fish Fillets',amount:'4'},{name:'Potatoes',amount:'4 large'},{name:'Flour',amount:'1 cup'},{name:'Beer',amount:'1 cup'},{name:'Oil',amount:'for frying'},{name:'Peas',amount:'1 cup'}],steps:['Cut potatoes into chips','Soak chips in cold water 30 mins','Make batter with flour and beer','Heat oil to 180C','Fry chips until golden','Coat fish in batter','Fry fish 4-5 mins per side','Serve with peas and tartar sauce']},
{id:'m12',name:'Pad Thai',icon:'noodle',tags:['Quick','Fresh'],ingredients:[{name:'Rice Noodles',amount:'250g'},{name:'Shrimp',amount:'300g'},{name:'Eggs',amount:'2'},{name:'Bean Sprouts',amount:'1 cup'},{name:'Peanuts',amount:'1/4 cup'},{name:'Lime',amount:'2'},{name:'Fish Sauce',amount:'3 tbsp'},{name:'Tamarind Paste',amount:'2 tbsp'}],steps:['Soak noodles in warm water','Make sauce with fish sauce and tamarind','Stir fry shrimp, set aside','Scramble eggs in wok','Add noodles and sauce','Toss with bean sprouts','Top with peanuts and lime']},
{id:'m13',name:'Lasagna',icon:'italian',tags:['Comfort','Bulk Prep'],ingredients:[{name:'Lasagna Sheets',amount:'12'},{name:'Ground Beef',amount:'500g'},{name:'Ricotta',amount:'500g'},{name:'Mozzarella',amount:'300g'},{name:'Parmesan',amount:'100g'},{name:'Tomato Sauce',amount:'700g'},{name:'Onion',amount:'1'}],steps:['Make meat sauce with beef and tomatoes','Mix ricotta with egg','Layer sauce, pasta, ricotta, mozzarella','Repeat layers 3 times','Top with parmesan','Bake at 180C for 45 mins','Rest 10 mins before cutting']},
{id:'m14',name:'Greek Salad',icon:'salad',tags:['Healthy','Quick','Vegetarian','Fresh'],ingredients:[{name:'Cucumber',amount:'1'},{name:'Tomatoes',amount:'4'},{name:'Red Onion',amount:'1/2'},{name:'Feta Cheese',amount:'200g'},{name:'Olives',amount:'1/2 cup'},{name:'Olive Oil',amount:'3 tbsp'},{name:'Oregano',amount:'1 tsp'}],steps:['Chop cucumber and tomatoes','Slice red onion thinly','Combine in bowl','Add olives and feta','Dress with oil and oregano']},
{id:'m15',name:'Chicken Parmesan',icon:'chicken',tags:['Comfort','Fresh'],ingredients:[{name:'Chicken Breast',amount:'4'},{name:'Breadcrumbs',amount:'1 cup'},{name:'Parmesan',amount:'1/2 cup'},{name:'Marinara',amount:'2 cups'},{name:'Mozzarella',amount:'200g'},{name:'Eggs',amount:'2'}],steps:['Pound chicken thin','Dip in egg then breadcrumb-parmesan mix','Fry until golden','Place in baking dish','Top with marinara and mozzarella','Bake 20 mins at 200C','Serve over pasta']},
{id:'m16',name:'Ramen',icon:'noodle',tags:['Comfort','Quick'],ingredients:[{name:'Ramen Noodles',amount:'4 packets'},{name:'Chicken Stock',amount:'8 cups'},{name:'Soy Sauce',amount:'4 tbsp'},{name:'Eggs',amount:'4'},{name:'Green Onions',amount:'4'},{name:'Nori',amount:'4 sheets'},{name:'Pork Belly',amount:'300g'}],steps:['Simmer pork in stock 2 hours','Soft boil eggs 6.5 mins','Heat stock with soy sauce','Cook noodles separately','Assemble: noodles, broth, pork','Top with egg, nori, green onions']},
{id:'m17',name:'Quesadillas',icon:'wrap',tags:['Quick','Comfort'],ingredients:[{name:'Tortillas',amount:'4 large'},{name:'Cheese',amount:'2 cups'},{name:'Chicken',amount:'2 cups'},{name:'Bell Peppers',amount:'2'},{name:'Salsa',amount:'1 cup'},{name:'Sour Cream',amount:'1/2 cup'}],steps:['Shred cooked chicken','Slice peppers','Lay tortilla, add cheese and fillings','Fold in half','Cook on griddle until golden','Flip and cook other side','Serve with salsa and sour cream']},
{id:'m18',name:'Shepherds Pie',icon:'comfort',tags:['Comfort','Bulk Prep'],ingredients:[{name:'Ground Lamb',amount:'500g'},{name:'Potatoes',amount:'1kg'},{name:'Carrots',amount:'2'},{name:'Peas',amount:'1 cup'},{name:'Onion',amount:'1'},{name:'Beef Stock',amount:'1 cup'},{name:'Butter',amount:'50g'}],steps:['Brown lamb with onion','Add diced carrots and stock','Simmer 20 mins','Add peas','Make mashed potatoes with butter','Spread meat in dish','Top with mashed potatoes','Bake at 200C for 25 mins']},
{id:'m19',name:'Pancakes',icon:'breakfast',tags:['Quick','Comfort'],ingredients:[{name:'Flour',amount:'2 cups'},{name:'Milk',amount:'1.5 cups'},{name:'Eggs',amount:'2'},{name:'Butter',amount:'3 tbsp'},{name:'Sugar',amount:'2 tbsp'},{name:'Baking Powder',amount:'2 tsp'},{name:'Maple Syrup',amount:'for serving'}],steps:['Mix dry ingredients','Whisk wet ingredients','Combine until just mixed','Heat griddle to medium','Pour 1/4 cup batter per pancake','Flip when bubbles form','Serve with butter and syrup']},
{id:'m20',name:'Burrito Bowl',icon:'mexican',tags:['Healthy','Fresh'],ingredients:[{name:'Rice',amount:'2 cups'},{name:'Black Beans',amount:'400g can'},{name:'Chicken',amount:'500g'},{name:'Corn',amount:'1 cup'},{name:'Avocado',amount:'2'},{name:'Salsa',amount:'1 cup'},{name:'Lime',amount:'2'}],steps:['Cook and season rice with lime','Grill seasoned chicken, slice','Warm black beans','Chop avocado','Assemble bowls: rice, beans, chicken','Top with corn, avocado, salsa']},
{id:'m21',name:'French Toast',icon:'breakfast',tags:['Quick','Comfort'],ingredients:[{name:'Bread',amount:'8 slices'},{name:'Eggs',amount:'4'},{name:'Milk',amount:'1/2 cup'},{name:'Cinnamon',amount:'1 tsp'},{name:'Vanilla',amount:'1 tsp'},{name:'Butter',amount:'2 tbsp'},{name:'Maple Syrup',amount:'for serving'}],steps:['Whisk eggs, milk, cinnamon, vanilla','Heat butter in pan','Dip bread in egg mixture','Cook until golden each side','Serve with syrup and berries']},
{id:'m22',name:'Meatballs',icon:'italian',tags:['Comfort','Bulk Prep'],ingredients:[{name:'Ground Beef',amount:'500g'},{name:'Breadcrumbs',amount:'1/2 cup'},{name:'Egg',amount:'1'},{name:'Parmesan',amount:'1/4 cup'},{name:'Garlic',amount:'2 cloves'},{name:'Marinara',amount:'3 cups'},{name:'Pasta',amount:'400g'}],steps:['Mix beef, breadcrumbs, egg, parmesan, garlic','Form into 20 meatballs','Brown in pan','Add to marinara, simmer 20 mins','Cook pasta','Serve meatballs over pasta']},
{id:'m23',name:'BLT Sandwich',icon:'sandwich',tags:['Quick','Fresh'],ingredients:[{name:'Bacon',amount:'8 strips'},{name:'Lettuce',amount:'4 leaves'},{name:'Tomato',amount:'2'},{name:'Bread',amount:'8 slices'},{name:'Mayo',amount:'4 tbsp'}],steps:['Cook bacon until crispy','Toast bread','Spread mayo on bread','Layer lettuce, tomato, bacon','Close sandwich and slice']},
{id:'m24',name:'Mac and Cheese',icon:'comfort',tags:['Comfort','Quick'],ingredients:[{name:'Macaroni',amount:'400g'},{name:'Cheddar',amount:'300g'},{name:'Milk',amount:'2 cups'},{name:'Butter',amount:'3 tbsp'},{name:'Flour',amount:'3 tbsp'},{name:'Mustard',amount:'1 tsp'}],steps:['Cook macaroni al dente','Make roux with butter and flour','Add milk slowly, whisk','Stir in cheese until melted','Add mustard, salt, pepper','Mix in macaroni','Optional: bake with breadcrumb topping']},
{id:'m25',name:'Teriyaki Chicken',icon:'asian',tags:['Quick','Healthy'],ingredients:[{name:'Chicken Thighs',amount:'600g'},{name:'Soy Sauce',amount:'1/2 cup'},{name:'Mirin',amount:'1/4 cup'},{name:'Sugar',amount:'2 tbsp'},{name:'Ginger',amount:'1 tbsp'},{name:'Rice',amount:'2 cups'},{name:'Broccoli',amount:'2 cups'}],steps:['Make sauce: soy, mirin, sugar, ginger','Grill or pan-fry chicken','Brush with sauce while cooking','Steam broccoli','Cook rice','Slice chicken, serve over rice','Drizzle extra sauce']}
];
const BADGES=[
// Cooking milestones (meals logged in past)
{id:1,icon:'üç≥',name:'First Bite',desc:'Log your first meal'},
{id:2,icon:'ü•Ñ',name:'Getting Started',desc:'Log 5 meals'},
{id:3,icon:'üç¥',name:'Kitchen Regular',desc:'Log 10 meals'},
{id:4,icon:'üçΩÔ∏è',name:'Home Cook',desc:'Log 25 meals'},
{id:5,icon:'üë®‚Äçüç≥',name:'Dedicated Chef',desc:'Log 50 meals'},
{id:6,icon:'üë©‚Äçüç≥',name:'Master Chef',desc:'Log 100 meals'},
{id:7,icon:'üèÜ',name:'Kitchen Legend',desc:'Log 200 meals'},
{id:8,icon:'üëë',name:'Culinary Royalty',desc:'Log 500 meals'},
// Planning milestones (meals scheduled for future)
{id:9,icon:'üìÖ',name:'Forward Thinker',desc:'Plan a meal for tomorrow'},
{id:10,icon:'üóìÔ∏è',name:'Week Ahead',desc:'Plan a meal 7+ days out'},
{id:11,icon:'üìÜ',name:'Month Planner',desc:'Plan a meal 30+ days out'},
{id:12,icon:'üîÆ',name:'Fortune Teller',desc:'Plan a meal 60+ days out'},
// Weekly planning
{id:13,icon:'üìã',name:'Weekly Planner',desc:'Plan all 14 slots for a week'},
{id:14,icon:'üìù',name:'Two Week Warrior',desc:'Plan 2 full weeks'},
{id:15,icon:'üóíÔ∏è',name:'Month of Meals',desc:'Plan 4 full weeks'},
// Streaks (consecutive days with logged meals)
{id:16,icon:'üî•',name:'On a Roll',desc:'Log meals 3 days in a row'},
{id:17,icon:'‚ö°',name:'Week Streak',desc:'Log meals 7 days in a row'},
{id:18,icon:'üí´',name:'Two Week Streak',desc:'Log meals 14 days in a row'},
{id:19,icon:'üåü',name:'Month Streak',desc:'Log meals 30 days in a row'},
{id:20,icon:'üíé',name:'Diamond Streak',desc:'Log meals 60 days in a row'},
// Lunch specific
{id:21,icon:'‚òÄÔ∏è',name:'Lunch Starter',desc:'Log 5 lunches'},
{id:22,icon:'üåû',name:'Lunch Regular',desc:'Log 25 lunches'},
{id:23,icon:'üåÖ',name:'Lunch Champion',desc:'Log 50 lunches'},
// Dinner specific
{id:24,icon:'üåô',name:'Dinner Starter',desc:'Log 5 dinners'},
{id:25,icon:'üåÉ',name:'Dinner Regular',desc:'Log 25 dinners'},
{id:26,icon:'üåå',name:'Dinner Champion',desc:'Log 50 dinners'},
// Both meals in a day
{id:27,icon:'üç±',name:'Full Day',desc:'Log both lunch and dinner in one day'},
{id:28,icon:'üì¶',name:'Full Week',desc:'Log both meals every day for a week'},
// Meal Picker usage
{id:29,icon:'üé∞',name:'Lucky Spin',desc:'Use the meal picker once'},
{id:30,icon:'üé≤',name:'Spin Fan',desc:'Use the meal picker 10 times'},
{id:31,icon:'üéØ',name:'Spin Master',desc:'Use the meal picker 50 times'},
{id:32,icon:'üé™',name:'Spin Legend',desc:'Use the meal picker 100 times'},
// Shopping cart
{id:33,icon:'üõí',name:'First Shop',desc:'Add items to cart'},
{id:34,icon:'‚úÖ',name:'List Maker',desc:'Check off 10 cart items'},
{id:35,icon:'üõçÔ∏è',name:'Shopping Pro',desc:'Check off 50 cart items'},
{id:36,icon:'üè™',name:'Shopping Master',desc:'Check off 100 cart items'},
// Creating meals
{id:37,icon:'üìù',name:'Recipe Writer',desc:'Create your first meal'},
{id:38,icon:'üìö',name:'Recipe Author',desc:'Create 5 meals'},
{id:39,icon:'üìñ',name:'Recipe Publisher',desc:'Create 10 meals'},
{id:40,icon:'üèõÔ∏è',name:'Recipe Librarian',desc:'Create 25 meals'},
// Editing meals
{id:41,icon:'‚úèÔ∏è',name:'Editor',desc:'Edit a meal'},
{id:42,icon:'üîß',name:'Tinkerer',desc:'Edit 10 meals'},
// Tag usage (logged meals with specific tags)
{id:43,icon:'ü•ó',name:'Fresh Start',desc:'Log 5 Fresh meals'},
{id:44,icon:'üåø',name:'Fresh Fan',desc:'Log 25 Fresh meals'},
{id:45,icon:'üå±',name:'Fresh Master',desc:'Log 50 Fresh meals'},
{id:46,icon:'‚ùÑÔ∏è',name:'Freezer Friend',desc:'Log 5 Frozen meals'},
{id:47,icon:'üßä',name:'Freezer Fan',desc:'Log 25 Frozen meals'},
{id:48,icon:'‚ö°',name:'Quick Cook',desc:'Log 5 Quick meals'},
{id:49,icon:'üí®',name:'Speed Chef',desc:'Log 25 Quick meals'},
{id:50,icon:'üöÄ',name:'Lightning Fast',desc:'Log 50 Quick meals'},
{id:51,icon:'üõãÔ∏è',name:'Comfort Seeker',desc:'Log 5 Comfort meals'},
{id:52,icon:'üè†',name:'Comfort Lover',desc:'Log 25 Comfort meals'},
{id:53,icon:'üíö',name:'Health Starter',desc:'Log 5 Healthy meals'},
{id:54,icon:'üí™',name:'Health Hero',desc:'Log 25 Healthy meals'},
{id:55,icon:'üèÉ',name:'Health Champion',desc:'Log 50 Healthy meals'},
{id:56,icon:'ü•¨',name:'Veggie Curious',desc:'Log 5 Vegetarian meals'},
{id:57,icon:'ü•¶',name:'Veggie Lover',desc:'Log 25 Vegetarian meals'},
{id:58,icon:'üåΩ',name:'Veggie Master',desc:'Log 50 Vegetarian meals'},
{id:59,icon:'üì¶',name:'Bulk Starter',desc:'Log 5 Bulk Prep meals'},
{id:60,icon:'üóÉÔ∏è',name:'Bulk Master',desc:'Log 25 Bulk Prep meals'},
// Variety
{id:61,icon:'üé®',name:'Variety Pack',desc:'Log 5 different meals'},
{id:62,icon:'üåà',name:'Rainbow Menu',desc:'Log 10 different meals'},
{id:63,icon:'üé≠',name:'Diverse Diner',desc:'Log 25 different meals'},
{id:64,icon:'üåç',name:'World Eater',desc:'Log 50 different meals'},
// Cooking together
{id:65,icon:'üë•',name:'Team Cook',desc:'Assign both people as cooking'},
{id:66,icon:'üíë',name:'Cooking Duo',desc:'Cook together 10 times'},
{id:67,icon:'‚ù§Ô∏è',name:'Kitchen Partners',desc:'Cook together 25 times'},
// Same meal repeat
{id:68,icon:'üîÅ',name:'Repeat Customer',desc:'Log the same meal 5 times'},
{id:69,icon:'üíù',name:'Favorite Found',desc:'Log the same meal 10 times'},
{id:70,icon:'üòç',name:'True Love',desc:'Log the same meal 25 times'},
// Calendar coverage
{id:71,icon:'üìä',name:'Half Full',desc:'Fill 50% of a week'},
{id:72,icon:'üìà',name:'Almost There',desc:'Fill 75% of a week'},
{id:73,icon:'üíØ',name:'Perfect Week',desc:'Fill 100% of a week'},
// Time-based
{id:74,icon:'üåÖ',name:'Early Bird',desc:'Plan breakfast/lunch before 9am'},
{id:75,icon:'ü¶â',name:'Night Owl',desc:'Plan dinner after 8pm'},
// App milestones
{id:76,icon:'üì±',name:'App Explorer',desc:'Visit all 5 tabs'},
{id:77,icon:'‚öôÔ∏è',name:'Customizer',desc:'Open settings'},
{id:78,icon:'üè∑Ô∏è',name:'Tag Creator',desc:'Create a custom tag'},
// Monthly achievements
{id:79,icon:'üìÖ',name:'January Chef',desc:'Log 10+ meals in a month'},
{id:80,icon:'üóìÔ∏è',name:'Monthly Master',desc:'Log 30+ meals in a month'},
{id:81,icon:'üéñÔ∏è',name:'Monthly Legend',desc:'Log 50+ meals in a month'},
// Cart from meals
{id:82,icon:'üß∫',name:'Smart Shopper',desc:'Add ingredients from a meal to cart'},
{id:83,icon:'üìã',name:'Meal Prepper',desc:'Add 5 meals worth of ingredients'},
{id:84,icon:'üõí',name:'Bulk Buyer',desc:'Add 10 meals worth of ingredients'},
// Clearing/completing
{id:85,icon:'‚ú®',name:'Clean Slate',desc:'Clear the shopping cart'},
{id:86,icon:'üßπ',name:'Fresh Start',desc:'Clear cart 5 times'},
// Specific counts
{id:87,icon:'üîü',name:'Ten Down',desc:'Log 10 meals total'},
{id:88,icon:'2Ô∏è‚É£',name:'Twenty Club',desc:'Log 20 meals total'},
{id:89,icon:'5Ô∏è‚É£',name:'Fifty Milestone',desc:'Log 50 meals total'},
{id:90,icon:'üíØ',name:'Century Chef',desc:'Log 100 meals total'},
// Weekend cooking
{id:91,icon:'üéâ',name:'Weekend Warrior',desc:'Log meals on Saturday and Sunday'},
{id:92,icon:'üèñÔ∏è',name:'Weekend Regular',desc:'Log 10 weekend meals'},
// Tags explored
{id:93,icon:'üîç',name:'Tag Explorer',desc:'Use 3 different tags'},
{id:94,icon:'üèÖ',name:'Tag Collector',desc:'Use 5 different tags'},
{id:95,icon:'üéóÔ∏è',name:'Tag Master',desc:'Use all default tags'},
// Long term
{id:96,icon:'üìÜ',name:'One Month In',desc:'Use the app for 30 days'},
{id:97,icon:'üóìÔ∏è',name:'Three Months',desc:'Use the app for 90 days'},
{id:98,icon:'üìÖ',name:'Six Months',desc:'Use the app for 180 days'},
{id:99,icon:'üéÇ',name:'One Year',desc:'Use the app for 365 days'},
// Ultimate
{id:100,icon:'‚≠ê',name:'Tempero Master',desc:'Unlock 50 badges'}
];
let state={pin:'',data:{meals:STARTER_MEALS,calendar:{},cart:[],badges:{},tags:DEFAULT_TAGS,people:DEFAULT_PEOPLE,cookLog:[],settings:{}},weekOffset:0,selectedMeal:null,selectedSlot:null,editingMeal:null,mealTags:[],mealIngredients:[],mealSteps:[],tagFilter:'all',pickerFilter:'all',pickerIngredient:'',recipeViewMode:'list',recipeStep:0,calendarMealType:'lunch',addToCalendarMealId:null,pat:localStorage.getItem('github_pat')||''};
const $=id=>document.getElementById(id),$$=sel=>document.querySelectorAll(sel),genId=()=>'m'+Date.now().toString(36)+Math.random().toString(36).substr(2,5);
function getWeekDates(offset=0){const now=new Date();const start=new Date(now);start.setDate(now.getDate()-now.getDay()+1+offset*7);const dates=[];for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);dates.push(d);}return dates;}
function fmtDate(d){return d.toISOString().split('T')[0];}
function fmtDateDisplay(d){return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});}
function updateDots(){$$('#pinDots .pin-dot').forEach((d,i)=>d.classList.toggle('filled',i<state.pin.length));}
function pinInput(n){if(state.pin.length<4){state.pin+=n;updateDots();if(state.pin.length===4){setTimeout(()=>{if(state.pin===CONFIG.PIN){$('pinScreen').classList.add('hidden');$('app').classList.add('active');localStorage.setItem('pin_verified','true');loadData();}else{$$('#pinDots .pin-dot').forEach(d=>d.classList.add('error'));setTimeout(()=>{state.pin='';$$('#pinDots .pin-dot').forEach(d=>d.classList.remove('error','filled'));},500);}},200);}}}
$$('.pin-key').forEach(k=>{const handler=()=>{if(k.dataset.num!==undefined)pinInput(k.dataset.num);else if(k.dataset.action==='back'){state.pin=state.pin.slice(0,-1);updateDots();}};k.addEventListener('click',handler);k.addEventListener('touchend',e=>{e.preventDefault();handler();},{passive:false});});
function setDate(){$('headerDate').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});}
$$('.nav-item[data-page]').forEach(n=>{const doNav=()=>{const p=n.dataset.page;$$('.page').forEach(x=>x.classList.remove('active'));$(p).classList.add('active');$$('.nav-item').forEach(x=>x.classList.remove('active'));n.classList.add('active');if(p==='pageCalendar')renderCalendar();if(p==='pageMeals')renderMeals();if(p==='pagePicker')renderPicker();if(p==='pageCart')renderCart();if(p==='pageAwards')renderAwards();};n.addEventListener('click',doNav);});
function saveToLocal(){try{state.data._version=Date.now();localStorage.setItem('tempero_data',JSON.stringify(state.data));return true;}catch(e){console.error('Local save failed:',e);return false;}}
function loadFromLocal(){try{const saved=localStorage.getItem('tempero_data');if(saved){const loaded=JSON.parse(saved);state.data={...state.data,...loaded};return true;}return false;}catch(e){console.error('Local load failed:',e);return false;}}
async function loadData(){const hadLocal=loadFromLocal();const localVersion=state.data._version||0;if(state.pat){$('syncStatus').classList.add('syncing');try{const u=await fetch('https://api.github.com/user',{headers:{'Authorization':'Bearer '+state.pat}});if(u.ok)CONFIG.REPO_OWNER=(await u.json()).login;const r=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{headers:{'Authorization':'Bearer '+state.pat}});if(r.ok){const d=await r.json();const githubData=JSON.parse(atob(d.content));const githubVersion=githubData._version||0;if(githubVersion>localVersion){state.data={...state.data,...githubData};saveToLocal();}}}catch(e){console.error(e);}$('syncStatus').classList.remove('syncing');}if(!state.data.meals||!state.data.meals.length){state.data.meals=STARTER_MEALS;saveToLocal();}renderCalendar();renderMeals();}
async function saveData(){saveToLocal();if(!state.pat)return true;$('syncStatus').classList.add('syncing');try{const u=await fetch('https://api.github.com/user',{headers:{'Authorization':'Bearer '+state.pat}});if(u.ok)CONFIG.REPO_OWNER=(await u.json()).login;const g=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{headers:{'Authorization':'Bearer '+state.pat}});let sha=g.ok?(await g.json()).sha:null;const body={message:'Update '+new Date().toISOString(),content:btoa(unescape(encodeURIComponent(JSON.stringify(state.data,null,2))))};if(sha)body.sha=sha;const result=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{method:'PUT',headers:{'Authorization':'Bearer '+state.pat,'Content-Type':'application/json'},body:JSON.stringify(body)});$('syncStatus').classList.remove('syncing');return result.ok;}catch(e){console.error(e);$('syncStatus').classList.remove('syncing');return false;}}
function showToast(msg,err){const t=$('toast');t.textContent=msg;t.classList.toggle('error',!!err);t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function renderCalendar(){const dates=getWeekDates(state.weekOffset);const start=fmtDateDisplay(dates[0]);const end=fmtDateDisplay(dates[6]);$('weekTitle').textContent=start+' - '+end;let html='';dates.forEach(d=>{const key=fmtDate(d);const dayData=state.data.calendar[key]||{};const lunch=dayData.lunch;const dinner=dayData.dinner;const isToday=fmtDate(new Date())===key;html+=`<div class="day-card"><div class="day-header"><span>${d.toLocaleDateString('en-US',{weekday:'long'})}</span><span class="day-date">${isToday?'Today':d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span></div>`;html+=renderMealSlot(key,'lunch',lunch);html+=renderMealSlot(key,'dinner',dinner);html+='</div>';});$('weekDays').innerHTML=html;}
function renderMealSlot(date,type,data){const meal=data?state.data.meals.find(m=>m.id===data.mealId):null;const icon=type==='lunch'?'üåû':'üåô';const typeName=type.charAt(0).toUpperCase()+type.slice(1);if(!meal){return `<div class="meal-slot" onclick="openSlotModal('${date}','${type}')"><div class="meal-slot-icon">${icon}</div><div class="meal-slot-content"><div class="meal-slot-type">${typeName}</div><div class="meal-slot-name empty">No meal assigned</div></div><div class="meal-slot-arrow">+</div></div>`;}
const eating=data.eating?.join(', ')||'';const cooking=Array.isArray(data.cooking)?data.cooking.join(', '):(data.cooking||'');return `<div class="meal-slot" onclick="openSlotModal('${date}','${type}')"><div class="meal-slot-icon">${icon}</div><div class="meal-slot-content"><div class="meal-slot-type">${typeName}</div><div class="meal-slot-name">${meal.name}</div>${eating||cooking?`<div class="meal-slot-meta">${eating?'üë• '+eating:''}${eating&&cooking?' ¬∑ ':''}${cooking?'üë®‚Äçüç≥ '+cooking:''}</div>`:''}</div><div class="meal-slot-arrow">‚Ä∫</div></div>`;}
window.openSlotModal=(date,type)=>{state.selectedSlot={date,type};state.slotTagFilter='all';state.slotSearchQuery='';const dayData=state.data.calendar[date]||{};const slotData=dayData[type]||{};$('slotMealSelect').value=slotData.mealId||'';$('slotMealSearch').value='';renderSlotMealPicker();const cookingArr=Array.isArray(slotData.cooking)?slotData.cooking:(slotData.cooking?[slotData.cooking]:[]);renderPersonSelect('slotEatingSelect',slotData.eating||[],true);renderPersonSelect('slotCookingSelect',cookingArr,true);$('slotModal').classList.add('active');};
function renderSlotMealPicker(){const tags=state.data.tags||DEFAULT_TAGS;let tagHtml='<button class="tag-btn '+(state.slotTagFilter==='all'?'active':'')+'" data-tag="all">All</button>';tags.forEach(t=>{tagHtml+=`<button class="tag-btn ${state.slotTagFilter===t?'active':''}" data-tag="${t}">${t}</button>`;});$('slotTagFilter').innerHTML=tagHtml;$('slotTagFilter').querySelectorAll('.tag-btn').forEach(btn=>{btn.addEventListener('click',()=>{state.slotTagFilter=btn.dataset.tag;renderSlotMealPicker();});});const search=state.slotSearchQuery.toLowerCase();const currentId=$('slotMealSelect').value;let meals=state.data.meals.filter(m=>{if(state.slotTagFilter!=='all'&&(!m.tags||!m.tags.includes(state.slotTagFilter)))return false;if(search&&!m.name.toLowerCase().includes(search))return false;return true;});const recentMealIds=[...new Set(Object.values(state.data.calendar).flatMap(d=>[d.lunch?.mealId,d.dinner?.mealId]).filter(Boolean))].slice(0,5);const recentMeals=meals.filter(m=>recentMealIds.includes(m.id));const otherMeals=meals.filter(m=>!recentMealIds.includes(m.id));let html='';if(recentMeals.length&&!search){html+='<div class="meal-picker-section">Recent</div>';recentMeals.forEach(m=>{html+=`<div class="meal-picker-item ${m.id===currentId?'selected':''}" data-id="${m.id}"><div class="meal-picker-item-name">${m.name}</div><div class="meal-picker-item-tags">${(m.tags||[]).join(' ¬∑ ')}</div></div>`;});html+='<div class="meal-picker-section">All Meals</div>';}otherMeals.forEach(m=>{html+=`<div class="meal-picker-item ${m.id===currentId?'selected':''}" data-id="${m.id}"><div class="meal-picker-item-name">${m.name}</div><div class="meal-picker-item-tags">${(m.tags||[]).join(' ¬∑ ')}</div></div>`;});if(!meals.length)html='<div style="padding:1rem;text-align:center;color:var(--text-muted)">No meals found</div>';$('slotMealList').innerHTML=html;$('slotMealList').querySelectorAll('.meal-picker-item').forEach(item=>{item.addEventListener('click',()=>{$('slotMealSelect').value=item.dataset.id;renderSlotMealPicker();});});}
$('slotMealSearch').addEventListener('input',e=>{state.slotSearchQuery=e.target.value;renderSlotMealPicker();});
function renderPersonSelect(containerId,selected,allowCustom=true){const people=state.data.people||DEFAULT_PEOPLE;let html='';people.forEach(p=>{const isActive=selected.includes(p);const colorClass=p.toLowerCase()==='rachel'?'rachel':p.toLowerCase()==='joel'?'joel':'';html+=`<button class="person-btn ${colorClass} ${isActive?'active':''}" data-person="${p}">${p}</button>`;});const customInSlot=selected.filter(s=>!people.includes(s));customInSlot.forEach(p=>{html+=`<button class="person-btn active" data-person="${p}">${p}<span class="delete-custom" data-delete="${p}">√ó</span></button>`;});if(allowCustom){html+=`<button class="person-btn add-custom-btn" data-action="add-custom">+</button>`;}$(containerId).innerHTML=html;$(containerId).querySelectorAll('.person-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{if(e.target.classList.contains('delete-custom')){e.stopPropagation();const nameToDelete=e.target.dataset.delete;const newSelected=getSelectedPeople(containerId).filter(p=>p!==nameToDelete);renderPersonSelect(containerId,newSelected,allowCustom);return;}if(btn.dataset.action==='add-custom'){const name=prompt('Enter name:');if(name&&name.trim()){const trimmedName=name.trim();renderPersonSelect(containerId,[...getSelectedPeople(containerId),trimmedName],allowCustom);}}else{btn.classList.toggle('active');}});});}
function getSelectedPeople(containerId){return[...$(containerId).querySelectorAll('.person-btn.active')].map(b=>b.dataset.person).filter(p=>p&&p!=='add-custom');}
$('closeSlotModal').addEventListener('click',()=>$('slotModal').classList.remove('active'));
$('slotModal').addEventListener('click',e=>{if(e.target.id==='slotModal')$('slotModal').classList.remove('active');});
$('saveSlotBtn').addEventListener('click',()=>{const mealId=$('slotMealSelect').value;const eating=getSelectedPeople('slotEatingSelect');const cooking=getSelectedPeople('slotCookingSelect');if(!state.data.calendar[state.selectedSlot.date])state.data.calendar[state.selectedSlot.date]={};if(mealId){state.data.calendar[state.selectedSlot.date][state.selectedSlot.type]={mealId,eating,cooking};logCook(mealId,cooking);}else{delete state.data.calendar[state.selectedSlot.date][state.selectedSlot.type];}$('slotModal').classList.remove('active');renderCalendar();saveData();showToast('Meal assigned!');});
function logCook(mealId,cooks){const meal=state.data.meals.find(m=>m.id===mealId);if(!meal)return;if(!state.data.cookLog)state.data.cookLog=[];const cookList=Array.isArray(cooks)?cooks:[cooks];cookList.forEach(cook=>{if(cook)state.data.cookLog.push({mealId,cook,date:new Date().toISOString(),tags:meal.tags||[]});});checkBadges();}
function renderMeals(){const tags=state.data.tags||DEFAULT_TAGS;let tagHtml='<button class="tag-btn '+(state.tagFilter==='all'?'active':'')+'" data-tag="all">All</button>';tags.forEach(t=>{tagHtml+=`<button class="tag-btn ${state.tagFilter===t?'active':''}" data-tag="${t}">${t}</button>`;});$('tagFilter').innerHTML=tagHtml;$('tagFilter').querySelectorAll('.tag-btn').forEach(btn=>{btn.addEventListener('click',()=>{state.tagFilter=btn.dataset.tag;renderMeals();});});const search=$('mealsSearchInput').value.toLowerCase();let meals=state.data.meals.filter(m=>{if(state.tagFilter!=='all'&&(!m.tags||!m.tags.includes(state.tagFilter)))return false;if(search&&!m.name.toLowerCase().includes(search))return false;return true;});if(!meals.length){$('mealsList').innerHTML='<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><p>No meals found</p></div>';return;}
let html='';meals.forEach(m=>{const tagsHtml=(m.tags||[]).map(t=>`<span class="meal-tag ${t.toLowerCase().replace(/\s/g,'')}">${t}</span>`).join('');html+=`<div class="meal-item" onclick="openMealOptions('${m.id}')"><div class="meal-item-content"><div class="meal-item-name">${m.name}</div><div class="meal-item-tags">${tagsHtml}</div></div></div>`;});$('mealsList').innerHTML=html;}
$('mealsSearchInput').addEventListener('input',renderMeals);
window.openMealOptions=id=>{state.selectedMeal=id;const meal=state.data.meals.find(m=>m.id===id);$('mealOptionsTitle').textContent=meal?meal.name:'Meal Options';$('mealOptionsModal').classList.add('active');};
$('closeMealOptions').addEventListener('click',()=>$('mealOptionsModal').classList.remove('active'));
$('mealOptionsModal').addEventListener('click',e=>{if(e.target.id==='mealOptionsModal')$('mealOptionsModal').classList.remove('active');});
$('optionMake').addEventListener('click',()=>{$('mealOptionsModal').classList.remove('active');openRecipe(state.selectedMeal);});
$('optionCalendar').addEventListener('click',()=>{$('mealOptionsModal').classList.remove('active');openAddToCalendar(state.selectedMeal);});
$('optionEdit').addEventListener('click',()=>{$('mealOptionsModal').classList.remove('active');openMealForm(state.selectedMeal);});
$('optionDelete').addEventListener('click',()=>{$('confirmText').textContent='Delete this meal?';$('confirmModal').classList.add('active');});
$('confirmCancel').addEventListener('click',()=>$('confirmModal').classList.remove('active'));
$('confirmOk').addEventListener('click',()=>{state.data.meals=state.data.meals.filter(m=>m.id!==state.selectedMeal);$('confirmModal').classList.remove('active');$('mealOptionsModal').classList.remove('active');renderMeals();saveData();showToast('Meal deleted');});
function openRecipe(id){const meal=state.data.meals.find(m=>m.id===id);if(!meal)return;state.recipeStep=0;renderRecipe(meal);$('recipeModal').classList.add('active');}
function renderRecipe(meal){let html=`<div class="recipe-header"><div class="recipe-name">${meal.name}</div><div class="recipe-tags">${(meal.tags||[]).map(t=>`<span class="meal-tag">${t}</span>`).join('')}</div></div>`;
html+=`<div class="recipe-section"><div class="recipe-section-title">ü•ó Ingredients</div>`;(meal.ingredients||[]).forEach(ing=>{html+=`<div class="recipe-ingredient"><span>${ing.name}</span><span>${ing.amount}</span></div>`;});html+='</div>';
html+=`<div class="view-toggle"><button class="${state.recipeViewMode==='list'?'active':''}" onclick="setRecipeView('list')">List View</button><button class="${state.recipeViewMode==='step'?'active':''}" onclick="setRecipeView('step')">Step by Step</button></div>`;
html+=`<div class="recipe-section"><div class="recipe-section-title">üìù Instructions</div>`;
if(state.recipeViewMode==='list'){(meal.steps||[]).forEach((step,i)=>{html+=`<div class="recipe-step"><div class="recipe-step-num">${i+1}</div><div class="recipe-step-text">${step}</div></div>`;});}else{const step=meal.steps?.[state.recipeStep]||'No steps';html+=`<div class="step-single"><div class="step-single-num">Step ${state.recipeStep+1} of ${meal.steps?.length||1}</div><div class="step-single-text">${step}</div></div><div class="recipe-nav"><button class="prev" onclick="prevStep()" ${state.recipeStep===0?'disabled':''}>‚Üê Previous</button><button class="next" onclick="nextStep(${meal.steps?.length||1})">${state.recipeStep>=(meal.steps?.length||1)-1?'Done':'Next ‚Üí'}</button></div>`;}
html+='</div>';
html+=`<div class="recipe-actions"><button class="btn-calendar" onclick="openAddToCalendar('${meal.id}')">üìÖ Add to Calendar</button></div>`;
$('recipeView').innerHTML=html;}
window.setRecipeView=mode=>{state.recipeViewMode=mode;const meal=state.data.meals.find(m=>m.id===state.selectedMeal);renderRecipe(meal);};
window.prevStep=()=>{if(state.recipeStep>0){state.recipeStep--;const meal=state.data.meals.find(m=>m.id===state.selectedMeal);renderRecipe(meal);}};
window.nextStep=total=>{if(state.recipeStep<total-1){state.recipeStep++;const meal=state.data.meals.find(m=>m.id===state.selectedMeal);renderRecipe(meal);}else{$('recipeModal').classList.remove('active');showToast('Recipe complete! üéâ');}};
$('closeRecipe').addEventListener('click',()=>$('recipeModal').classList.remove('active'));
function openAddToCalendar(id){state.addToCalendarMealId=id;$('calendarDateInput').value=fmtDate(new Date());renderPersonSelect('calEatingSelect',[],true);renderPersonSelect('calCookingSelect',[],false);$('addToCalendarModal').classList.add('active');}
window.openAddToCalendar=openAddToCalendar;
$('calTypeLunch').addEventListener('click',()=>{state.calendarMealType='lunch';$('calTypeLunch').classList.add('active');$('calTypeDinner').classList.remove('active');});
$('calTypeDinner').addEventListener('click',()=>{state.calendarMealType='dinner';$('calTypeDinner').classList.add('active');$('calTypeLunch').classList.remove('active');});
$('closeCalendarModal').addEventListener('click',()=>$('addToCalendarModal').classList.remove('active'));
$('addToCalendarModal').addEventListener('click',e=>{if(e.target.id==='addToCalendarModal')$('addToCalendarModal').classList.remove('active');});
$('saveCalendarBtn').addEventListener('click',()=>{const date=$('calendarDateInput').value;if(!date){showToast('Select a date',true);return;}const eating=getSelectedPeople('calEatingSelect');const cooking=getSelectedPeople('calCookingSelect');if(!state.data.calendar[date])state.data.calendar[date]={};state.data.calendar[date][state.calendarMealType]={mealId:state.addToCalendarMealId,eating,cooking};$('addToCalendarModal').classList.remove('active');logCook(state.addToCalendarMealId,cooking);saveData();showToast('Added to calendar!');});
function renderPicker(){const tags=state.data.tags||DEFAULT_TAGS;let tagHtml='<button class="tag-btn '+(state.pickerFilter==='all'?'active':'')+'" data-tag="all">All</button>';tags.forEach(t=>{tagHtml+=`<button class="tag-btn ${state.pickerFilter===t?'active':''}" data-tag="${t}">${t}</button>`;});$('pickerTagFilter').innerHTML=tagHtml;$('pickerTagFilter').querySelectorAll('.tag-btn').forEach(btn=>{btn.addEventListener('click',()=>{state.pickerFilter=btn.dataset.tag;renderPicker();});});$('spinResult').classList.remove('show');buildSlotReel();}
function getFilteredMeals(){return state.data.meals.filter(m=>{if(state.pickerFilter!=='all'&&(!m.tags||!m.tags.includes(state.pickerFilter)))return false;if(state.pickerIngredient){const hasIng=(m.ingredients||[]).some(i=>i.name.toLowerCase().includes(state.pickerIngredient));if(!hasIng)return false;}return true;});}
function buildSlotReel(){const meals=getFilteredMeals();if(!meals.length){$('slotReel').innerHTML='<div class="slot-item"><span class="slot-item-name" style="color:var(--text-muted)">No meals match filters</span></div>';return;}
let items=[];for(let i=0;i<3;i++)items=items.concat(meals);let html='';items.forEach(m=>{html+=`<div class="slot-item"><span class="slot-item-name">${m.name}</span></div>`;});$('slotReel').innerHTML=html;$('slotReel').style.transform='translateY(0)';}
$('pickerIngredientInput').addEventListener('input',e=>{state.pickerIngredient=e.target.value.toLowerCase();buildSlotReel();});
function createConfetti(){const container=document.createElement('div');container.className='confetti-container';document.body.appendChild(container);const colors=['#f97316','#2dd4bf','#fbbf24','#f472b6','#60a5fa','#ef4444','#a78bfa','#22c55e'];const shapes=['üéâ','üéä','‚ú®','‚≠ê','üåü','üß°','üíõ'];for(let i=0;i<50;i++){const confetti=document.createElement('div');confetti.className='confetti';confetti.style.left=Math.random()*100+'%';confetti.style.animationDelay=Math.random()*0.5+'s';confetti.style.animationDuration=(2+Math.random()*2)+'s';if(Math.random()>0.5){confetti.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];confetti.style.borderRadius=Math.random()>0.5?'50%':'0';confetti.style.width=(5+Math.random()*10)+'px';confetti.style.height=(5+Math.random()*10)+'px';}else{confetti.textContent=shapes[Math.floor(Math.random()*shapes.length)];confetti.style.fontSize='20px';confetti.style.background='none';}container.appendChild(confetti);}setTimeout(()=>container.remove(),4000);}
$('spinBtn').addEventListener('click',()=>{const meals=getFilteredMeals();if(!meals.length){showToast('No meals match filters',true);return;}$('spinBtn').disabled=true;$('spinResult').classList.remove('show');const winnerIdx=Math.floor(Math.random()*meals.length);const winner=meals[winnerIdx];state.selectedMeal=winner.id;const reel=$('slotReel');const itemHeight=70;const totalItems=meals.length*3;const winnerPos=meals.length+winnerIdx;const targetY=-(winnerPos*itemHeight)+(140-itemHeight/2);let currentY=0;const spins=2;const totalDistance=spins*totalItems*itemHeight+Math.abs(targetY);const duration=3000;const startTime=Date.now();function animate(){const elapsed=Date.now()-startTime;const progress=Math.min(elapsed/duration,1);const eased=1-Math.pow(1-progress,3);currentY=-eased*totalDistance;const loopY=currentY%(totalItems*itemHeight);reel.style.transform=`translateY(${loopY}px)`;if(progress<1){requestAnimationFrame(animate);}else{reel.style.transform=`translateY(${targetY}px)`;$('spinBtn').disabled=false;$('spinResultMeal').textContent=winner.name;$('spinResult').classList.add('show');createConfetti();if(!state.data.badges)state.data.badges={};state.data.badges['spin_count']=(state.data.badges['spin_count']||0)+1;checkBadges();saveData();}}animate();});
$('spinMakeBtn').addEventListener('click',()=>{openRecipe(state.selectedMeal);});
$('spinCalendarBtn').addEventListener('click',()=>{openAddToCalendar(state.selectedMeal);});
function renderCart(){const cart=state.data.cart||[];$('cartCount').textContent=cart.length+' item'+(cart.length!==1?'s':'');if(!cart.length){$('cartItems').innerHTML='<div class="empty-state"><div class="empty-state-icon">üõí</div><p>Your cart is empty</p></div>';return;}
let html='';cart.forEach((item,i)=>{html+=`<div class="cart-item ${item.checked?'checked':''}"><button class="cart-checkbox ${item.checked?'checked':''}" onclick="toggleCartItem(${i})">${item.checked?'‚úì':''}</button><div class="cart-item-content"><div class="cart-item-name">${item.name}</div>${item.amount?`<div class="cart-item-amount">${item.amount}</div>`:''}${item.source?`<div class="cart-item-source">From: ${item.source}</div>`:''}</div><button class="cart-item-delete" onclick="deleteCartItem(${i})">√ó</button></div>`;});$('cartItems').innerHTML=html;}
window.toggleCartItem=i=>{state.data.cart[i].checked=!state.data.cart[i].checked;renderCart();saveData();};
window.deleteCartItem=i=>{state.data.cart.splice(i,1);renderCart();saveData();};
$('clearCartBtn').addEventListener('click',()=>{if(!state.data.cart?.length)return;$('confirmText').textContent='Clear all items from cart?';$('confirmModal').classList.add('active');$('confirmOk').onclick=()=>{state.data.cart=[];$('confirmModal').classList.remove('active');renderCart();saveData();showToast('Cart cleared');};});
$('addFromMealBtn').addEventListener('click',()=>{let options='<option value="">Select a meal...</option>';state.data.meals.forEach(m=>{options+=`<option value="${m.id}">${m.name}</option>`;});$('cartMealSelect').innerHTML=options;$('addFromMealModal').classList.add('active');});
$('closeAddFromMealModal').addEventListener('click',()=>$('addFromMealModal').classList.remove('active'));
$('addFromMealModal').addEventListener('click',e=>{if(e.target.id==='addFromMealModal')$('addFromMealModal').classList.remove('active');});
$('addMealToCartBtn').addEventListener('click',()=>{const mealId=$('cartMealSelect').value;if(!mealId){showToast('Select a meal',true);return;}const meal=state.data.meals.find(m=>m.id===mealId);if(!meal)return;if(!state.data.cart)state.data.cart=[];(meal.ingredients||[]).forEach(ing=>{state.data.cart.push({name:ing.name,amount:ing.amount,source:meal.name,checked:false});});$('addFromMealModal').classList.remove('active');renderCart();saveData();showToast('Ingredients added!');});
$('addCustomItemBtn').addEventListener('click',()=>{$('customItemName').value='';$('customItemAmount').value='';$('addCustomItemModal').classList.add('active');});
$('closeCustomItemModal').addEventListener('click',()=>$('addCustomItemModal').classList.remove('active'));
$('addCustomItemModal').addEventListener('click',e=>{if(e.target.id==='addCustomItemModal')$('addCustomItemModal').classList.remove('active');});
$('addCustomItemToCartBtn').addEventListener('click',()=>{const name=$('customItemName').value.trim();if(!name){showToast('Enter item name',true);return;}if(!state.data.cart)state.data.cart=[];state.data.cart.push({name,amount:$('customItemAmount').value.trim(),checked:false});$('addCustomItemModal').classList.remove('active');renderCart();saveData();showToast('Item added!');});
function renderAwards(){const badges=state.data.badges||{};let html='';BADGES.forEach(b=>{const earned=badges[b.id];const rachelEarned=earned?.rachel;const joelEarned=earned?.joel;const isEarned=rachelEarned||joelEarned;let badgeHtml='';if(rachelEarned)badgeHtml+='<span class="award-badge rachel">R</span>';if(joelEarned)badgeHtml+='<span class="award-badge joel">J</span>';html+=`<div class="award-item ${isEarned?'earned':'locked'}" onclick="showAward(${b.id})"><div class="award-icon">${b.icon}</div><div class="award-name">${b.name}</div>${badgeHtml?`<div class="award-badges">${badgeHtml}</div>`:''}</div>`;});$('awardsGrid').innerHTML=html;}
window.showAward=id=>{const badge=BADGES.find(b=>b.id===id);const earned=state.data.badges?.[id]||{};$('awardModalIcon').textContent=badge.icon;$('awardModalName').textContent=badge.name;$('awardModalDesc').textContent=badge.desc;let earnedHtml='';if(earned.rachel)earnedHtml+=`<div class="award-earned-person rachel">‚úì Rachel</div>`;else earnedHtml+=`<div class="award-earned-person locked">Rachel: Locked</div>`;if(earned.joel)earnedHtml+=`<div class="award-earned-person joel">‚úì Joel</div>`;else earnedHtml+=`<div class="award-earned-person locked">Joel: Locked</div>`;$('awardModalEarned').innerHTML=earnedHtml;$('awardModal').classList.add('active');};
$('closeAwardModal').addEventListener('click',()=>$('awardModal').classList.remove('active'));
$('awardModal').addEventListener('click',e=>{if(e.target.id==='awardModal')$('awardModal').classList.remove('active');});
function checkBadges(){const log=state.data.cookLog||[];if(!state.data.badges)state.data.badges={};const people=state.data.people||DEFAULT_PEOPLE;people.forEach(person=>{const myLogs=log.filter(l=>l.cook===person);const count=myLogs.length;const tagCounts={};myLogs.forEach(l=>(l.tags||[]).forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;}));const checks=[{id:1,check:count>=1},{id:2,check:count>=5},{id:3,check:count>=10},{id:4,check:count>=25},{id:5,check:count>=50},{id:6,check:count>=100},{id:7,check:count>=200},{id:8,check:count>=500},{id:9,check:(tagCounts['Fresh']||0)>=5},{id:10,check:(tagCounts['Fresh']||0)>=25},{id:11,check:(tagCounts['Fresh']||0)>=50},{id:12,check:(tagCounts['Vegetarian']||0)>=5},{id:13,check:(tagCounts['Vegetarian']||0)>=25},{id:14,check:(tagCounts['Vegetarian']||0)>=50},{id:15,check:(tagCounts['Frozen']||0)>=5},{id:16,check:(tagCounts['Frozen']||0)>=25},{id:17,check:(tagCounts['Quick']||0)>=5},{id:18,check:(tagCounts['Quick']||0)>=25},{id:19,check:(tagCounts['Quick']||0)>=50},{id:20,check:(tagCounts['Comfort']||0)>=5},{id:21,check:(tagCounts['Comfort']||0)>=25},{id:22,check:(tagCounts['Healthy']||0)>=5},{id:23,check:(tagCounts['Healthy']||0)>=25},{id:24,check:(tagCounts['Healthy']||0)>=50},{id:25,check:(tagCounts['Bulk Prep']||0)>=5},{id:26,check:(tagCounts['Bulk Prep']||0)>=25},{id:32,check:(state.data.badges['spin_count']||0)>=1},{id:33,check:(state.data.badges['spin_count']||0)>=25},{id:37,check:(state.data.badges['meals_created_'+person]||0)>=1},{id:38,check:(state.data.badges['meals_created_'+person]||0)>=10},{id:39,check:(state.data.badges['meals_created_'+person]||0)>=25}];checks.forEach(c=>{if(c.check){if(!state.data.badges[c.id])state.data.badges[c.id]={};const key=person.toLowerCase();if(!state.data.badges[c.id][key])state.data.badges[c.id][key]=true;}});});}
function openMealForm(id=null){state.editingMeal=id;state.mealTags=[];state.mealIngredients=[];state.mealSteps=[];if(id){const meal=state.data.meals.find(m=>m.id===id);if(meal){$('mealFormTitle').textContent='Edit Meal';$('mealNameInput').value=meal.name;state.mealTags=[...(meal.tags||[])];state.mealIngredients=(meal.ingredients||[]).map(i=>({...i}));state.mealSteps=[...(meal.steps||[])];$('deleteMealBtn').style.display='block';}else{state.editingMeal=null;}}else{$('mealFormTitle').textContent='New Meal';$('mealNameInput').value='';$('deleteMealBtn').style.display='none';}renderTagsInput();renderIngredientsList();renderStepsList();$('mealFormModal').classList.add('active');}
function renderTagsInput(){const container=$('tagsInput');let html='<div class="selected-tags">';state.mealTags.forEach((t,i)=>{html+=`<span class="tag-chip">${t}<button onclick="removeTag(${i})">√ó</button></span>`;});html+='</div>';html+='<div class="available-tags">';const availableTags=(state.data.tags||DEFAULT_TAGS).filter(t=>!state.mealTags.includes(t));availableTags.forEach(t=>{html+=`<button class="available-tag-btn" onclick="addExistingTag('${t.replace(/'/g,"\\'")}')">${t}</button>`;});html+='</div>';html+='<div class="new-tag-row"><input type="text" id="tagInputField" placeholder="New tag..."><button class="add-tag-btn" onclick="addNewTag()">+</button></div>';container.innerHTML=html;}
window.addExistingTag=tag=>{if(!state.mealTags.includes(tag)){state.mealTags.push(tag);renderTagsInput();}};
window.addNewTag=()=>{const input=$('tagInputField');if(input.value.trim()){const tag=input.value.trim();state.mealTags.push(tag);if(!state.data.tags.includes(tag)){state.data.tags.push(tag);}renderTagsInput();}};
window.removeTag=i=>{state.mealTags.splice(i,1);renderTagsInput();};
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.id==='tagInputField'){e.preventDefault();addNewTag();}});
function renderIngredientsList(){if(!state.mealIngredients.length)state.mealIngredients=[{name:'',amount:''}];let html='';state.mealIngredients.forEach((ing,i)=>{html+=`<div class="ingredient-row"><input type="text" class="form-input" placeholder="Ingredient" value="${ing.name}" onchange="updateIngredient(${i},'name',this.value)"><input type="text" class="form-input amount" placeholder="Amount" value="${ing.amount}" onchange="updateIngredient(${i},'amount',this.value)"><button class="delete-btn" onclick="deleteIngredient(${i})">√ó</button></div>`;});$('ingredientsList').innerHTML=html;}
window.updateIngredient=(i,field,val)=>{state.mealIngredients[i][field]=val;};
window.deleteIngredient=i=>{if(state.mealIngredients.length>1){state.mealIngredients.splice(i,1);renderIngredientsList();}};
$('addIngredientBtn').addEventListener('click',()=>{state.mealIngredients.push({name:'',amount:''});renderIngredientsList();});
function renderStepsList(){if(!state.mealSteps.length)state.mealSteps=[''];let html='';state.mealSteps.forEach((step,i)=>{html+=`<div class="step-item"><div class="step-num">${i+1}</div><div class="step-content"><textarea placeholder="Step ${i+1}..." onchange="updateStep(${i},this.value)">${step}</textarea></div><button class="step-delete" onclick="deleteStep(${i})">√ó</button></div>`;});$('stepsList').innerHTML=html;}
window.updateStep=(i,val)=>{state.mealSteps[i]=val;};
window.deleteStep=i=>{if(state.mealSteps.length>1){state.mealSteps.splice(i,1);renderStepsList();}};
$('addStepBtn').addEventListener('click',()=>{state.mealSteps.push('');renderStepsList();});
$('closeMealForm').addEventListener('click',()=>$('mealFormModal').classList.remove('active'));
$('deleteMealBtn').addEventListener('click',()=>{$('confirmText').textContent='Delete this meal?';$('confirmModal').classList.add('active');$('confirmOk').onclick=()=>{state.data.meals=state.data.meals.filter(m=>m.id!==state.editingMeal);$('confirmModal').classList.remove('active');$('mealFormModal').classList.remove('active');renderMeals();saveData();showToast('Meal deleted');};});
$('saveMealBtn').addEventListener('click',()=>{const name=$('mealNameInput').value.trim();if(!name){showToast('Enter meal name',true);return;}const ingredients=state.mealIngredients.filter(i=>i.name.trim());const steps=state.mealSteps.filter(s=>s.trim());const mealData={name,tags:state.mealTags,ingredients,steps};if(state.editingMeal){const idx=state.data.meals.findIndex(m=>m.id===state.editingMeal);if(idx>=0){state.data.meals[idx]={...state.data.meals[idx],...mealData};}}else{mealData.id=genId();state.data.meals.push(mealData);state.data.badges['meals_created_'+((state.data.people||['Rachel'])[0])]=(state.data.badges['meals_created_'+((state.data.people||['Rachel'])[0])]||0)+1;checkBadges();}$('mealFormModal').classList.remove('active');renderMeals();renderPicker();saveData();showToast('Meal saved!');});
$('prevWeek').addEventListener('click',()=>{state.weekOffset--;renderCalendar();});
$('nextWeek').addEventListener('click',()=>{state.weekOffset++;renderCalendar();});
$('settingsBtn').addEventListener('click',()=>{$('patInput').value=state.pat;renderPeopleList();renderTagsList();$('settingsModal').classList.add('active');});
$('closeSettings').addEventListener('click',()=>$('settingsModal').classList.remove('active'));
function renderPeopleList(){const people=state.data.people||DEFAULT_PEOPLE;let html='';people.forEach((p,i)=>{html+=`<div class="people-item"><input type="text" value="${p}" onchange="updatePerson(${i},this.value)"><button onclick="deletePerson(${i})">√ó</button></div>`;});$('peopleList').innerHTML=html;}
window.updatePerson=(i,val)=>{state.data.people[i]=val;};
window.deletePerson=i=>{if(state.data.people.length>1){state.data.people.splice(i,1);renderPeopleList();}};
$('addPersonBtn').addEventListener('click',()=>{if(!state.data.people)state.data.people=[...DEFAULT_PEOPLE];state.data.people.push('New Person');renderPeopleList();});
function renderTagsList(){const tags=state.data.tags||DEFAULT_TAGS;let html='';tags.forEach((t,i)=>{const mealCount=state.data.meals.filter(m=>m.tags&&m.tags.includes(t)).length;html+=`<div class="tags-item"><input type="text" value="${t}" onchange="updateTag(${i},this.value)" data-original="${t}"><span class="tag-count">${mealCount}</span><button onclick="deleteTag(${i})">√ó</button></div>`;});$('tagsList').innerHTML=html;}
window.updateTag=(i,newVal)=>{const oldVal=state.data.tags[i];if(oldVal===newVal)return;state.data.meals.forEach(m=>{if(m.tags){const tagIdx=m.tags.indexOf(oldVal);if(tagIdx>=0)m.tags[tagIdx]=newVal;}});state.data.tags[i]=newVal;};
window.deleteTag=i=>{if(state.data.tags.length>1){const tagToDelete=state.data.tags[i];state.data.meals.forEach(m=>{if(m.tags){m.tags=m.tags.filter(t=>t!==tagToDelete);}});state.data.tags.splice(i,1);renderTagsList();}else{showToast('Must have at least one tag',true);}};
$('addTagBtn').addEventListener('click',()=>{if(!state.data.tags)state.data.tags=[...DEFAULT_TAGS];state.data.tags.push('New Tag');renderTagsList();});
$('resetDataBtn').addEventListener('click',()=>{$('confirmText').textContent='Reset all data? This cannot be undone!';$('confirmModal').classList.add('active');$('confirmOk').onclick=async()=>{localStorage.removeItem('tempero_data');state.data={meals:STARTER_MEALS,calendar:{},cart:[],badges:{},tags:DEFAULT_TAGS,people:DEFAULT_PEOPLE,cookLog:[],settings:{},_version:Date.now()};saveToLocal();const synced=await saveData();$('confirmModal').classList.remove('active');$('settingsModal').classList.remove('active');renderCalendar();renderMeals();renderPicker();renderCart();renderAwards();showToast(synced?'Data reset & synced!':'Data reset locally (sync failed)',!synced);};});
$('saveSettingsBtn').addEventListener('click',async()=>{state.pat=$('patInput').value.trim();localStorage.setItem('github_pat',state.pat);$('settingsModal').classList.remove('active');await saveData();renderMeals();renderPicker();showToast('Settings saved!');if(state.pat&&!CONFIG.REPO_OWNER)await loadData();});
function init(){setDate();loadFromLocal();if(localStorage.getItem('pin_verified')==='true'){$('pinScreen').classList.add('hidden');$('app').classList.add('active');loadData();}renderCalendar();renderMeals();renderPicker();renderCart();renderAwards();}
init();
</script>
</body>
</html>
